---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: dex
  namespace: platform-system
spec:
  releaseName: dex
  interval: 30m
  driftDetection:
    mode: enabled
  chartRef:
    kind: OCIRepository
    name: dex
  values:
    controllers:
      main:
        annotations:
          reloader.stakater.com/auto: "true"
        type: deployment
        replicas: 1
        strategy: Recreate
        serviceAccount:
          name: dex-generator
          create: false
        initContainers:
          generator:
            image:
              repository: python
              tag: "3.14-alpine"
            command:
              - /bin/sh
              - -c
              - |
                set -euo pipefail
                pip install --no-cache-dir --quiet pyyaml
                python /opt/generator/generator.py
            env:
              - name: CONFIG_TEMPLATE
                value: /generator/base.yaml
              - name: CONFIG_OUT
                value: /etc/dex/config.yaml
        containers:
          main:
            image:
              repository: ghcr.io/dexidp/dex
              tag: v2.44.0
            command:
              - dex
            args:
              - serve
              - /etc/dex/config.yaml
            env:
              - name: ENVOY_GATEWAY_CLIENT_SECRET
                valueFrom:
                  secretKeyRef:
                    name: envoy-oidc-client
                    key: client-secret
              - name: DEX_STATIC_PASSWORD_ADMIN_HASH
                valueFrom:
                  secretKeyRef:
                    name: dex-static-password
                    key: admin-hash
            ports:
              - name: http
                containerPort: 5556
            probes:
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: 5556
                  initialDelaySeconds: 15
                  periodSeconds: 15
                  timeoutSeconds: 5
                  failureThreshold: 3
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /healthz
                    port: 5556
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 5
    service:
      main:
        controller: main
        type: ClusterIP
        labels:
          gatus.edgard.org/enabled: "true"
        ports:
          http:
            port: 5556
            targetPort: 5556
    ingress:
      main:
        enabled: false
    persistence:
      config:
        type: emptyDir
        globalMounts:
          - path: /etc/dex
      generator:
        type: configMap
        name: dex-generator
        defaultMode: 0555
        globalMounts:
          - path: /generator
          - path: /opt/generator
      data:
        enabled: true
        type: hostPath
        hostPath: /mnt/spool/appdata/dex
        hostPathType: DirectoryOrCreate
        globalMounts:
          - path: /data
