{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",

  // Base configuration
  extends: [
    "config:recommended",
    ":semanticCommits",
    ":timezone(Europe/Warsaw)",
    ":prHourlyLimitNone",
    "docker:enableMajor",
  ],
  ignorePaths: ["**/*.sops.yaml", "**/*.sops.yml"],

  // Custom managers for non-standard files
  customManagers: [
    {
      customType: "regex",
      description: "Track Kind node images in bootstrap/config/cluster-config.yaml",
      managerFilePatterns: ["/^bootstrap/config/cluster-config\\.ya?ml$/"],
      matchStrings: [
        "image:\\s*(?:&\\S+\\s+)?(?<depName>kindest/node):(?<currentValue>[0-9A-Za-z_.\\-]+)",
      ],
      datasourceTemplate: "docker",
    },
    {
      customType: "regex",
      description: "Track WASM images in EnvoyExtensionPolicy manifests",
      managerFilePatterns: [
        "/^apps\\/[^\\/]+\\/[^\\/]+\\/manifests\\/.*\\.envoyextensionpolicy\\.ya?ml$/",
      ],
      matchStrings: [
        "url:\\s*(?<depName>[A-Za-z0-9._\\-]+(?:/[A-Za-z0-9._\\-]+)+):(?<currentValue>[0-9A-Za-z_.\\-]+)",
        "url:\\s*(?<depName>[A-Za-z0-9._\\-]+(?:/[A-Za-z0-9._\\-]+)+)@sha256:(?<currentValue>[A-Fa-f0-9]{64})",
      ],
      datasourceTemplate: "docker",
    },
    {
      customType: "regex",
      description: "Track charts in apps/*/*/config.yaml",
      managerFilePatterns: ["/^apps\\/[^\\/]+\\/[^\\/]+\\/config\\.ya?ml$/"],
      matchStrings: [
        "repo:\\s*oci://(?<packageName>[^\\s]+)\\s+path:\\s*[\"']?\\.[\"']?\\s+version:\\s*(?<currentValue>\\S+)",
        "repo:\\s*(?<registryUrl>https://[^\\s]+)\\s+name:\\s*(?<depName>\\S+)\\s+version:\\s*(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "{{#if packageName}}docker{{else}}helm{{/if}}",
    },
  ],

  packageRules: [
    // === Automerge behavior ===
    {
      description: "Auto-merge and group all non-major dependency updates",
      matchUpdateTypes: ["minor", "patch", "digest", "pin", "rollback"],
      groupName: "dependencies (non-major)",
      automerge: true,
      automergeType: "pr",
      platformAutomerge: false,
      ignoreTests: true,
    },
    {
      description: "Require manual review for major upgrades",
      matchUpdateTypes: ["major"],
      automerge: false,
      addLabels: ["renovate/manual-review"],
    },

    // === Grouping ===
    {
      description: "Group Kind cluster node updates into a single PR",
      matchFileNames: ["bootstrap/config/cluster-config.yaml"],
      groupName: "kind-nodes",
    },

    // === Disabled managers ===
    {
      description: "Disable Terraform version updates (using OpenTofu)",
      matchManagers: ["terraform-version"],
      enabled: false,
    },

    // === Package-specific overrides ===
    {
      description: "Only consider semver Jellyfin tags (ignore dated releases)",
      matchPackageNames: ["lscr.io/linuxserver/jellyfin"],
      allowedVersions: "/^\\d{1,2}\\.\\d+\\.\\d+$/",
    },
  ],
}
