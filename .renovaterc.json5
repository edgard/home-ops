{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",

  // === Presets ===
  extends: [
    "config:recommended",
    ":semanticCommits",
    ":timezone(Europe/Warsaw)",
    ":prHourlyLimitNone",
    "docker:enableMajor",
  ],

  // === Kubernetes Manager ===
  kubernetes: {
    managerFilePatterns: [
      "/^apps\\/.*\\/manifests\\/.*\\.yaml$/",
      "/^argocd\\/.*\\.yaml$/",
    ],
  },

  // === Custom Managers ===
  customManagers: [
    // Helm charts in app config.yaml files (OCI and HTTP repositories)
    {
      customType: "regex",
      description: "Helm charts in app config files",
      managerFilePatterns: ["/^apps\\/[^\\/]+\\/[^\\/]+\\/config\\.ya?ml$/"],
      matchStringsStrategy: "any",
      matchStrings: [
        "repo:\\s*oci://(?<packageName>[^\\s]+)\\s+path:\\s*[\"']?\\.[\"']?\\s+version:\\s*(?<currentValue>\\S+)",
        "repo:\\s*(?<registryUrl>https://[^\\s]+)\\s+name:\\s*(?<depName>\\S+)\\s+version:\\s*(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "{{#if packageName}}docker{{else}}helm{{/if}}",
    },

    // Gateway API CRDs (uses renovate comment hint)
    {
      customType: "regex",
      description: "Gateway API CRDs version",
      managerFilePatterns: [
        "/^apps\\/platform-system\\/gateway-api\\/manifests\\/gateway-api-version\\.configmap\\.ya?ml$/",
      ],
      matchStrings: [
        "# renovate: datasource=github-releases depName=(?<depName>[^\\s]+)[\\s\\S]*?version:\\s*[\"']?(?<currentValue>v[0-9.]+)[\"']?",
      ],
      datasourceTemplate: "github-releases",
    },

    // Talos installer in bootstrap machine config (preserve factory schematic path)
    {
      customType: "regex",
      description: "Talos installer image tag in bootstrap patch",
      managerFilePatterns: ["/^bootstrap\\/controlplane-patch\\.ya?ml$/"],
      matchStrings: [
        "image:\\s*(?<depName>factory\\.talos\\.dev\\/metal-installer\\/[a-z0-9]+):(?<currentValue>v[0-9]+\\.[0-9]+\\.[0-9]+(?:-[^\\s\"']+)?)",
      ],
      datasourceTemplate: "docker",
    },
  ],

  // === Package Rules ===
  packageRules: [
    // Resolve Talos updates from upstream installer tags while keeping factory path in file
    {
      description: "Override Talos installer package name",
      matchDatasources: ["docker"],
      matchDepNames: ["/factory\\.talos\\.dev\\/metal-installer\\//"],
      matchPackageNames: ["/factory\\.talos\\.dev\\/metal-installer\\//"],
      overridePackageName: "ghcr.io/siderolabs/installer",
    },

    // Manual review: Gateway API updates (CRD changes are risky)
    {
      description: "Require manual review for Gateway API updates",
      matchPackageNames: ["kubernetes-sigs/gateway-api"],
      automerge: false,
      groupName: "gateway-api",
      addLabels: ["renovate/manual-review"],
      postUpgradeTasks: {
        commands: [
          "curl -sL https://github.com/kubernetes-sigs/gateway-api/releases/download/{{{newVersion}}}/standard-install.yaml -o apps/platform-system/gateway-api/manifests/gateway-api-crds.yaml",
        ],
        fileFilters: ["apps/platform-system/gateway-api/manifests/**"],
        executionMode: "branch",
      },
    },

    // Manual review: major updates
    {
      description: "Require manual review for major updates",
      matchUpdateTypes: ["major"],
      matchPackageNames: ["!kubernetes-sigs/gateway-api"],
      automerge: false,
      groupName: "dependencies (major)",
      addLabels: ["renovate/manual-review"],
    },

    // Automerge: non-major updates (excluding manual review packages)
    {
      description: "Auto-merge non-major updates",
      matchUpdateTypes: ["minor", "patch", "digest", "pin", "rollback"],
      matchPackageNames: ["!kubernetes-sigs/gateway-api"],
      groupName: "dependencies (non-major)",
      automerge: true,
      automergeType: "branch",
      ignoreTests: true,
    },

    // Disabled: Terraform version manager (using OpenTofu)
    {
      description: "Disable Terraform version manager (using OpenTofu)",
      matchManagers: ["terraform-version"],
      enabled: false,
    },
  ],
}
