{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",

  // === Base Configuration ===
  extends: [
    "config:recommended",
    ":semanticCommits",
    ":timezone(Europe/Warsaw)",
    ":prHourlyLimitNone",
    "docker:enableMajor",
  ],

  // === Custom Managers ===
  customManagers: [
    // Bootstrap
    {
      customType: "regex",
      description: "Kind node images",
      managerFilePatterns: ["/^bootstrap/cluster-config\\.ya?ml$/"],
      matchStrings: [
        "image:\\s*(?:&\\S+\\s+)?(?<packageName>kindest/node):(?<currentValue>[0-9A-Za-z_.\\-]+)",
      ],
      datasourceTemplate: "docker",
    },
    {
      customType: "regex",
      description: "Bitwarden BWS CLI in bootstrap script",
      managerFilePatterns: ["/^bootstrap\\/bootstrap_kind\\.py$/"],
      matchStrings: [
        '"(?<packageName>bitwarden/bws):(?<currentValue>[0-9]+\\.[0-9]+\\.[0-9]+)"',
      ],
      datasourceTemplate: "docker",
    },

    // Apps - Helm charts
    {
      customType: "regex",
      description: "Helm charts in app config files",
      managerFilePatterns: ["/^apps\\/[^\\/]+\\/[^\\/]+\\/config\\.ya?ml$/"],
      matchStringsStrategy: "any",
      matchStrings: [
        "repo:\\s*oci://(?<packageName>[^\\s]+)\\s+path:\\s*[\"']?\\.[\"']?\\s+version:\\s*(?<currentValue>\\S+)",
        "repo:\\s*(?<registryUrl>https://[^\\s]+)\\s+name:\\s*(?<depName>\\S+)\\s+version:\\s*(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "{{#if packageName}}docker{{else}}helm{{/if}}",
    },

    // Apps - Manifests
    {
      customType: "regex",
      description: "Gateway API CRDs version",
      managerFilePatterns: [
        "/^apps\\/platform-system\\/gateway-api\\/manifests\\/gateway-api-version\\.ya?ml$/",
      ],
      matchStrings: [
        "# renovate: datasource=github-releases depName=(?<depName>[^\\s]+)[\\s\\S]*?version:\\s*[\"']?(?<currentValue>v[0-9.]+)[\"']?",
      ],
      datasourceTemplate: "github-releases",
    },
  ],

  // === Package Rules ===
  packageRules: [
    // Global automerge behavior
    {
      description: "Auto-merge non-major updates",
      matchUpdateTypes: ["minor", "patch", "digest", "pin", "rollback"],
      groupName: "dependencies (non-major)",
      automerge: true,
      automergeType: "pr",
      platformAutomerge: false,
      ignoreTests: true,
    },
    {
      description: "Require manual review for major updates",
      matchUpdateTypes: ["major"],
      automerge: false,
      addLabels: ["renovate/manual-review"],
    },

    // Grouping
    {
      description: "Group Kind node updates",
      matchFileNames: ["bootstrap/cluster-config.yaml"],
      groupName: "kind-nodes",
    },

    // Disabled
    {
      description: "Disable Terraform version manager (using OpenTofu)",
      matchManagers: ["terraform-version"],
      enabled: false,
    },

    // Package-specific
    {
      description: "Jellyfin: only semver tags",
      matchPackageNames: ["lscr.io/linuxserver/jellyfin"],
      allowedVersions: "/^\\d{1,2}\\.\\d+\\.\\d+$/",
    },
    {
      description: "Gateway API: auto-download CRDs on update",
      matchPackageNames: ["kubernetes-sigs/gateway-api"],
      postUpgradeTasks: {
        commands: [
          "curl -sL https://github.com/kubernetes-sigs/gateway-api/releases/download/{{{newVersion}}}/standard-install.yaml -o apps/platform-system/gateway-api/manifests/gateway-api-crds.yaml",
        ],
        fileFilters: ["apps/platform-system/gateway-api/manifests/**"],
        executionMode: "branch",
      },
    },
  ],
}
