{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",

  // === Presets ===
  extends: [
    "config:recommended",
    ":semanticCommits",
    ":timezone(Europe/Warsaw)",
    ":prHourlyLimitNone",
    "docker:enableMajor",
  ],

  // === Custom Managers ===
  customManagers: [
    // Helm charts in app config.yaml files (OCI and HTTP repositories)
    {
      customType: "regex",
      description: "Helm charts in app config files",
      managerFilePatterns: ["/^apps\\/[^\\/]+\\/[^\\/]+\\/config\\.ya?ml$/"],
      matchStringsStrategy: "any",
      matchStrings: [
        "repo:\\s*oci://(?<packageName>[^\\s]+)\\s+path:\\s*[\"']?\\.[\"']?\\s+version:\\s*(?<currentValue>\\S+)",
        "repo:\\s*(?<registryUrl>https://[^\\s]+)\\s+name:\\s*(?<depName>\\S+)\\s+version:\\s*(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "{{#if packageName}}docker{{else}}helm{{/if}}",
    },

    // Container images in Kubernetes manifests
    {
      customType: "regex",
      description: "Container images in manifest files",
      managerFilePatterns: ["/^apps\\/.*\\/manifests\\/.*\\.ya?ml$/"],
      matchStrings: ["image:\\s*(?<depName>[^:]+):(?<currentValue>[^\\s]+)"],
      datasourceTemplate: "docker",
    },

    // Gateway API CRDs (uses renovate comment hint)
    {
      customType: "regex",
      description: "Gateway API CRDs version",
      managerFilePatterns: ["/^apps\\/platform-system\\/gateway-api\\/manifests\\/gateway-api-version\\.ya?ml$/"],
      matchStrings: ["# renovate: datasource=github-releases depName=(?<depName>[^\\s]+)[\\s\\S]*?version:\\s*[\"']?(?<currentValue>v[0-9.]+)[\"']?"],
      datasourceTemplate: "github-releases",
    },

    // K3s version in Taskfile
    {
      customType: "regex",
      description: "K3s version in Taskfile",
      managerFilePatterns: ["/^Taskfile\\.ya?ml$/"],
      matchStrings: ["K3S_VERSION:.+default\\s+\"(?<currentValue>v[^\"]+)\""],
      depNameTemplate: "rancher/k3s",
      datasourceTemplate: "github-releases",
    },
  ],

  // === Package Rules ===
  packageRules: [
    // Automerge: non-major updates
    {
      description: "Auto-merge non-major updates",
      matchUpdateTypes: ["minor", "patch", "digest", "pin", "rollback"],
      groupName: "dependencies (non-major)",
      automerge: true,
      automergeType: "pr",
      platformAutomerge: false,
      ignoreTests: true,
    },

    // Automerge: major updates require manual review
    {
      description: "Require manual review for major updates",
      matchUpdateTypes: ["major"],
      automerge: false,
      addLabels: ["renovate/manual-review"],
    },

    // Manual review: K3s updates (cluster-critical)
    {
      description: "Require manual review for K3s updates",
      matchPackageNames: ["rancher/k3s"],
      automerge: false,
      addLabels: ["renovate/manual-review"],
    },

    // Disabled: Terraform version manager (using OpenTofu)
    {
      description: "Disable Terraform version manager (using OpenTofu)",
      matchManagers: ["terraform-version"],
      enabled: false,
    },

    // Post-upgrade: Gateway API CRDs auto-download
    {
      description: "Gateway API: auto-download CRDs on update",
      matchPackageNames: ["kubernetes-sigs/gateway-api"],
      postUpgradeTasks: {
        commands: [
          "curl -sL https://github.com/kubernetes-sigs/gateway-api/releases/download/{{{newVersion}}}/standard-install.yaml -o apps/platform-system/gateway-api/manifests/gateway-api-crds.yaml",
        ],
        fileFilters: ["apps/platform-system/gateway-api/manifests/**"],
        executionMode: "branch",
      },
    },
  ],
}
