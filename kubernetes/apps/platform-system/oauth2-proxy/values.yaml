controllers:
  main:
    annotations:
      reloader.stakater.com/auto: "true"
    type: deployment
    replicas: 1
    strategy: Recreate
    containers:
      main:
        image:
          repository: quay.io/oauth2-proxy/oauth2-proxy
          tag: v7.13.0
        env:
          TZ: Europe/Warsaw
          OAUTH2_PROXY_PROVIDER: oidc
          OAUTH2_PROXY_EMAIL_DOMAINS: "*"
          OAUTH2_PROXY_REDIRECT_URL: https://auth.edgard.org/oauth2/callback
          OAUTH2_PROXY_UPSTREAMS: file:///dev/null
          OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
          OAUTH2_PROXY_SET_AUTHORIZATION_HEADER: "true"
          OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
          OAUTH2_PROXY_PASS_AUTHORIZATION_HEADER: "true"
          OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
          OAUTH2_PROXY_COOKIE_DOMAINS: .edgard.org
          OAUTH2_PROXY_COOKIE_SECURE: "true"
          OAUTH2_PROXY_COOKIE_SAMESITE: lax
          OAUTH2_PROXY_COOKIE_REFRESH: 24h
          OAUTH2_PROXY_COOKIE_EXPIRE: 720h
          OAUTH2_PROXY_SCOPE: openid profile email
          OAUTH2_PROXY_OIDC_ISSUER_URL: https://id.edgard.org
          OAUTH2_PROXY_OIDC_EMAIL_CLAIM: email
          OAUTH2_PROXY_OIDC_GROUPS_CLAIM: groups
          OAUTH2_PROXY_REVERSE_PROXY: "true"
          OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
          OAUTH2_PROXY_WHITELIST_DOMAINS: .edgard.org
          OAUTH2_PROXY_SKIP_JWT_BEARER_TOKENS: "true"
          OAUTH2_PROXY_APPROVAL_PROMPT: auto
        envFrom:
          - secretRef:
              name: oauth2-proxy
        probes:
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /ping
                port: 4180
              initialDelaySeconds: 15
              periodSeconds: 15
              timeoutSeconds: 5
              failureThreshold: 3
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /ping
                port: 4180
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 5
              failureThreshold: 5
service:
  main:
    controller: main
    type: ClusterIP
    annotations:
      external-dns.alpha.kubernetes.io/hostname: auth.edgard.org
      external-dns.alpha.kubernetes.io/target: 192.168.1.241
    ports:
      http:
        port: 4180
        protocol: TCP
        targetPort: 4180
ingress:
  main:
    enabled: true
    className: nginx
    annotations:
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      external-dns.alpha.kubernetes.io/target: tunnel.edgard.org
    hosts:
      - host: auth.edgard.org
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: main
              port: http
    tls:
      - secretName: wildcard-edgard-org-tls
        hosts:
          - auth.edgard.org
persistence: {}
