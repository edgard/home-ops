---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-instance
  namespace: flux-system
spec:
  chartRef:
    kind: OCIRepository
    name: flux-instance
  interval: 1h
  values:
    instance:
      distribution:
        version: "2.x"
        registry: "ghcr.io/fluxcd"
      components:
        - source-controller
        - kustomize-controller
        - helm-controller
      cluster:
        networkPolicy: false
        size: small
      commonMetadata:
        labels:
          app.kubernetes.io/name: flux
      sync:
        kind: GitRepository
        url: https://github.com/edgard/home-ops.git
        ref: refs/heads/master
        path: kubernetes/flux/cluster
        interval: 15m
        pullSecret: home-ops-git
      kustomize:
        patches:
          - target:
              kind: Kustomization
              name: flux-system
              namespace: flux-system
            patch: |
              - op: add
                path: /spec/decryption
                value:
                  provider: sops
                  secretRef:
                    name: sops-age
