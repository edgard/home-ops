---
version: "3"

dotenv: [".envrc"]

vars:
  REPO_ROOT:
    sh: "git rev-parse --show-toplevel"

tasks:
  config:
    desc: Edit master secrets config file
    interactive: true
    silent: true
    cmds:
      - sops config.sops.yaml

  config-update:
    desc: Update secrets configuration files
    dir: ansible
    cmds:
      - ansible-playbook config.yaml

  config-push:
    desc: Push updated secrets configuration files
    interactive: true
    cmds:
      - git add config.sops.yaml
      - git add ansible/group_vars/all.sops.yaml
      - git add terraform/secrets.sops.yaml
      - git add cluster/config/cluster-secrets.yaml
      - git add cluster/core/wave1/cloudflared/secrets.yaml
      - git commit -m 'Update secrets configuration files' || true
      - git push

  apply-config:
    desc: Apply configuration across all tools
    cmds:
      - task: apply-ansible
      - task: apply-terraform
      - task: apply-flux

  apply-ansible:
    desc: Run Ansible site playbook
    dir: ansible
    cmds:
      - ansible-playbook site.yaml

  apply-terraform:
    desc: Apply terraform plan
    dir: terraform
    interactive: true
    cmds:
      - terraform apply

  apply-flux:
    desc: Start flux repository reconciliation
    cmds:
      - flux reconcile source git flux-system

  install-k3s:
    desc: Install K3s
    cmds:
      - k3sup install --ip $KUB_SERVER_IP --user $KUB_SERVER_USER --local-path ~/.kube/config --k3s-channel stable --k3s-extra-args '--write-kubeconfig-mode 0644 --disable-helm-controller --disable traefik'

  install-keys:
    desc: Install SOPS keys
    cmds:
      - kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f -
      - cat "{{.REPO_ROOT}}/.sops.agekey" | kubectl create secret generic sops-age --namespace=flux-system --from-file=sops.agekey=/dev/stdin

  install-flux:
    desc: Install Flux CD
    cmds:
      - kubectl create namespace flux-system --dry-run=client -o yaml | kubectl apply -f -
      - flux bootstrap github --components-extra=image-reflector-controller,image-automation-controller --owner="$GITHUB_USER" --repository="$GITHUB_REPO" --path=cluster/base --branch=master --read-write-key --personal
    preconditions:
      - flux check --pre

  system-upgrade:
    desc: Upgrade all servers
    dir: ansible
    cmds:
      - ansible-playbook upgrade.yaml
