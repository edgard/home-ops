---
version: "3"

silent: true
failfast: true
set:
  - errexit
  - nounset
  - pipefail
shell: bash -c

vars:
  TERRAFORM_DIR: '{{.TERRAFORM_DIR | default (printf "%s/terraform" .TASKFILE_DIR)}}'
  CLUSTER_NAME: '{{.CLUSTER_NAME | default "homelab"}}'
  K3S_VERSION: '{{.K3S_VERSION | default "v1.34.3+k3s1"}}'
  SSH_USER: '{{.SSH_USER | default "root"}}'

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  bootstrap:create:
    desc: Bootstrap K3s cluster with k3sup and deploy platform via helmfile
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TARGET_HOST
        - BWS_ACCESS_TOKEN
    env:
      TARGET_HOST: "{{.TARGET_HOST}}"
      BWS_ACCESS_TOKEN: "{{.BWS_ACCESS_TOKEN}}"
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
      K3S_VERSION: "{{.K3S_VERSION}}"
      SSH_USER: "{{.SSH_USER}}"
    cmds:
      - ./bootstrap.sh create

  bootstrap:destroy:
    desc: Destroy K3s cluster
    interactive: true
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TARGET_HOST
    env:
      TARGET_HOST: "{{.TARGET_HOST}}"
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
      SSH_USER: "{{.SSH_USER}}"
    cmds:
      - ./bootstrap.sh destroy

  bootstrap:recreate:
    desc: Destroy and recreate K3s cluster
    interactive: true
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TARGET_HOST
        - BWS_ACCESS_TOKEN
    env:
      TARGET_HOST: "{{.TARGET_HOST}}"
      BWS_ACCESS_TOKEN: "{{.BWS_ACCESS_TOKEN}}"
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
      K3S_VERSION: "{{.K3S_VERSION}}"
      SSH_USER: "{{.SSH_USER}}"
    cmds:
      - ./bootstrap.sh recreate

  bootstrap:update:
    desc: Update K3s to specified version
    interactive: true
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TARGET_HOST
    env:
      TARGET_HOST: "{{.TARGET_HOST}}"
      CLUSTER_NAME: "{{.CLUSTER_NAME}}"
      K3S_VERSION: "{{.K3S_VERSION}}"
      SSH_USER: "{{.SSH_USER}}"
    cmds:
      - ./bootstrap.sh update

  lint:
    desc: Format + lint YAML
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - 'prettier --write "**/*.{yaml,yml}"'
      - 'yamlfmt "**/*.{yaml,yml}"'
      - "yamllint ."

  argo:sync:
    desc: Force Argo CD Applications to refresh
    vars:
      app: '{{.app | default ""}}'
    cmds:
      - 'kubectl -n argocd get applications {{if .app}}-l "app={{.app}}"{{end}} -o name | xargs -r -n1 -I{} kubectl -n argocd patch {} --type merge -p ''{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'' >/dev/null || true'

  argo:pf:
    desc: Port-forward Argo CD server locally
    interactive: true
    cmds:
      - kubectl -n argocd port-forward svc/argocd-server 8080:80

  tf:plan:
    desc: Terraform plan
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - CLOUDFLARE_API_TOKEN
        - TF_VAR_cloudflare_zone_id
    cmds:
      - "tofu init"
      - "tofu plan"

  tf:apply:
    desc: Terraform apply
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - CLOUDFLARE_API_TOKEN
        - TF_VAR_cloudflare_zone_id
    cmds:
      - "tofu init"
      - "tofu apply"

  tf:validate:
    desc: Terraform fmt + validate
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - CLOUDFLARE_API_TOKEN
        - TF_VAR_cloudflare_zone_id
    cmds:
      - "tofu fmt -recursive"
      - "tofu validate"

  tf:clean:
    desc: Clean terraform state/cache
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - rm -rf .terraform/ .terraform.lock.hcl terraform.tfstate* *.tfplan
