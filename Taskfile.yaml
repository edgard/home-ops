---
version: "3"

silent: true
failfast: true
set:
  - errexit
  - nounset
  - pipefail
shell: bash -c

vars:
  TERRAFORM_DIR: '{{.TERRAFORM_DIR | default (printf "%s/terraform" .TASKFILE_DIR)}}'

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  bootstrap:create:
    desc: Provision Kind cluster and install Argo CD
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - BWS_ACCESS_TOKEN
    cmds:
      - "python3 bootstrap_kind.py"
      - "helmfile -f helmfile.yaml.gotmpl sync"

  bootstrap:destroy:
    desc: Destroy Kind cluster via bootstrap
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    cmds:
      - "python3 bootstrap_kind.py --destroy"

  bootstrap:recreate:
    desc: Recreate Kind cluster via bootstrap
    cmds:
      - task: bootstrap:destroy
        ignore_error: true
      - task: bootstrap:create

  lint:
    desc: Format + lint YAML
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - 'prettier --write "**/*.{yaml,yml}"'
      - 'yamlfmt "**/*.{yaml,yml}"'
      - "yamllint ."

  argo:sync:
    desc: Force Argo CD Applications to refresh
    summary: |
      Refreshes Argo CD Applications. Pass `app=<name>` to target a label `app=<name>`; leave empty to refresh all.
    vars:
      app: '{{.app | default ""}}'
    cmds:
      - 'kubectl -n argocd get applications {{if .app}}-l "app={{.app}}"{{end}} -o name | xargs -r -n1 -I{} kubectl -n argocd patch {} --type merge -p ''{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'' >/dev/null || true'

  argo:pf:
    desc: Port-forward Argo CD server locally
    interactive: true
    cmds:
      - kubectl -n argocd port-forward svc/argocd-server 8080:80

  tf:plan:
    desc: Terraform plan
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - CLOUDFLARE_API_TOKEN
        - TF_VAR_cloudflare_zone_id
    cmds:
      - "tofu init"
      - "tofu plan"

  tf:apply:
    desc: Terraform apply
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - CLOUDFLARE_API_TOKEN
        - TF_VAR_cloudflare_zone_id
    cmds:
      - "tofu init"
      - "tofu apply"

  tf:validate:
    desc: Terraform fmt + validate
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - CLOUDFLARE_API_TOKEN
        - TF_VAR_cloudflare_zone_id
    cmds:
      - "tofu fmt -recursive"
      - "tofu validate"

  tf:clean:
    desc: Clean terraform state/cache
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - rm -rf .terraform/ .terraform.lock.hcl terraform.tfstate* *.tfplan
