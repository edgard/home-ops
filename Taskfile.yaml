---
version: "3"

silent: true
failfast: true
set:
  - errexit
  - nounset
  - pipefail
shell: bash -c

vars:
  TERRAFORM_DIR: '{{.TERRAFORM_DIR | default (printf "%s/terraform" .TASKFILE_DIR)}}'
  TALOS_CLUSTER_NAME: '{{.TALOS_CLUSTER_NAME | default "homelab"}}'
  TALOS_INSTALL_DISK: '{{.TALOS_INSTALL_DISK | default ""}}'
  TALOS_NODE: '{{.TALOS_NODE | default ""}}'

tasks:
  default:
    desc: List available tasks
    cmds:
      - task --list

  talos:gen:
    desc: Generate Talos config into ~/.talos
    requires:
      vars:
        - TALOS_NODE
        - TALOS_CLUSTER_NAME
        - TALOS_INSTALL_DISK
    cmds:
      - "{{.TASKFILE_DIR}}/.scripts/talos-gen.sh"

  talos:apply:
    desc: Apply Talos config to control plane
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TALOS_NODE
    vars:
      INSECURE:
        sh: |
          if talosctl version --nodes "{{.TALOS_NODE}}" --short >/dev/null 2>&1; then
            echo ""
          else
            echo "--insecure"
          fi
    cmds:
      - talosctl config endpoints "{{.TALOS_NODE}}" >/dev/null 2>&1
      - talosctl apply-config {{.INSECURE}} --nodes "{{.TALOS_NODE}}" --file "$HOME/.talos/controlplane.yaml"

  talos:bootstrap:
    desc: Bootstrap Talos control plane and kubeconfig
    interactive: true
    requires:
      vars:
        - TALOS_NODE
        - TALOS_CLUSTER_NAME
    cmds:
      - "{{.TASKFILE_DIR}}/.scripts/talos-bootstrap.sh"

  talos:upgrade:
    desc: Upgrade Talos on a node using the image from machine config
    requires:
      vars:
        - TALOS_NODE
    cmds:
      - "{{.TASKFILE_DIR}}/.scripts/talos-upgrade.sh"

  talos:upgrade-k8s:
    desc: Upgrade Kubernetes control plane
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TALOS_NODE
        - K8S_VERSION
    cmds:
      - talosctl -n "{{.TALOS_NODE}}" upgrade-k8s --to "{{.K8S_VERSION}}"

  cluster:create:
    desc: Install, configure, and bootstrap Talos + platform
    requires:
      vars:
        - TALOS_NODE
        - TALOS_CLUSTER_NAME
        - TALOS_INSTALL_DISK
        - BWS_ACCESS_TOKEN
    cmds:
      - task: talos:gen
      - task: talos:apply
      - task: talos:bootstrap
      - task: platform:create

  cluster:destroy:
    desc: Destroy platform and reset Talos node
    interactive: true
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - TALOS_NODE
    cmds:
      - task: platform:destroy
      - talosctl reset --nodes "{{.TALOS_NODE}}" --graceful=false --reboot

  platform:create:
    desc: Create platform components via helmfile
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    requires:
      vars:
        - BWS_ACCESS_TOKEN
    env:
      BWS_ACCESS_TOKEN: "{{.BWS_ACCESS_TOKEN}}"
    cmds:
      - helmfile -f helmfile.yaml.gotmpl sync

  platform:destroy:
    desc: Destroy platform components via helmfile
    interactive: true
    dir: "{{.TASKFILE_DIR}}/bootstrap"
    cmds:
      - helmfile -f helmfile.yaml.gotmpl destroy

  argo:sync:
    desc: Force Argo CD Applications to refresh
    vars:
      app: '{{.app | default ""}}'
    cmds:
      - APP="{{.app}}" "{{.TASKFILE_DIR}}/.scripts/argo-sync.sh"

  fmt:
    desc: Format all code
    dir: "{{.TASKFILE_DIR}}"
    cmds:
      - prettier --write "**/*.{yaml,yml}"
      - yamlfmt "**/*.{yaml,yml}"
      - tofu fmt -recursive

  lint:
    desc: Lint all code
    dir: "{{.TASKFILE_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - BWS_ACCESS_TOKEN
    cmds:
      - pre-commit run --all-files

  tf:plan:
    desc: Terraform plan
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - BWS_ACCESS_TOKEN
    env:
      BW_ACCESS_TOKEN: "{{.BWS_ACCESS_TOKEN}}"
    cmds:
      - tofu init
      - tofu plan

  tf:apply:
    desc: Terraform apply
    dir: "{{.TERRAFORM_DIR}}"
    requires:
      vars:
        - AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY
        - BWS_ACCESS_TOKEN
    env:
      BW_ACCESS_TOKEN: "{{.BWS_ACCESS_TOKEN}}"
    cmds:
      - tofu init
      - tofu apply

  tf:clean:
    desc: Clean terraform state/cache
    dir: "{{.TERRAFORM_DIR}}"
    cmds:
      - rm -rf .terraform/ .terraform.lock.hcl terraform.tfstate* *.tfplan
