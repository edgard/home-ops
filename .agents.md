# AI Maintainer Guide

- Keep this file current. Any change to automation, commands, dependencies, layout, or docs must update `.agents.md` (and README.md) in the same commit/PR.
- Default to safe edits: never drop user changes, never commit decrypted secrets, avoid destructive git operations unless explicitly asked.
- Prefer `rg`/`rg --files` for search; stay ASCII unless a file already uses other characters.
- README is intentionally high level; keep detailed procedures and dependency notes here.

## Repo Layout
- `bootstrap/config/` – Kind cluster config and SOPS credentials template (`cluster-config.yaml`, `cluster-credentials.template.yaml`, encrypted `cluster-credentials.sops.yaml`). Age key lives locally at `.sops.agekey`.
- `bootstrap/scripts/bootstrap.py` – Kind/Multus/Argo installer. Bootstrap expects Docker context `kind-<cluster>` (default `kind-homelab`) to exist.
- `argocd/` – `root.app.yaml` bootstraps namespaces, projects, and the ApplicationSet (`appsets/apps.appset.yaml` with sync-wave ordering).
- `apps/<group>/<app>/` – `config.yaml` (chart source/version + optional rollout/sync), `values.yaml`, optional `manifests/` (always synced). Groups: argocd, kube-system, local-path-storage, platform-system, ops, selfhosted, media, home-automation.
- `terraform/` – OpenTofu configs for Cloudflare using Backblaze B2 S3 backend (`shadowhausterraform/homelab/terraform.tfstate`); module in `terraform/cloudflare/`.

## Bootstrap Flow
- Dependencies: docker, kind, kubectl, helm, python3 + PyYAML, sops + age-keygen, go-task (`task`), prettier, yamlfmt, yamllint, tofu.
- Bootstrap uses `bootstrap/config/helmfile.yaml.gotmpl` to install pre-Argo dependencies in order: local-path-provisioner (chart + manifests, postsync hook demotes Kind’s default StorageClass), Multus, and Argo CD. Chart refs/versions are read from each app’s `config.yaml`. The Argo repo Secret is created via an argocd presync hook (reads credentials from the applied `cluster-credentials` Secret using kubectl/jsonpath), and the Argo root app is applied via an argocd postsync hook. Argo later reconciles the same apps; helmfile only runs on fresh cluster create. Bootstrap now fails if cluster credentials are missing/invalid. Paths inside the helmfile are relative to `bootstrap/config/`.
- Create docker context `kind-homelab` (or `kind-<name>` from `cluster-config.yaml`) pointing at the host running dockerd; bootstrap fails if the context is missing.
- `task secrets:create-key` → writes `.sops.agekey`; `task secrets:edit` → populates/edits `cluster-credentials.sops.yaml` from the template.
- `task bootstrap:run` creates Kind, attaches workers to a macvlan network, patches kubeconfig endpoint (if remote), installs Multus and Argo CD via Helm using versions from app configs, applies cluster secrets, seeds the Argo repo secret, then applies the root Argo CD app.
- Busybox warmup remains (kind loads `docker.io/library/busybox:stable` into all nodes).
- Kind containerd registry auth: placeholders in `bootstrap/config/cluster-config.yaml` (`__DOCKERHUB_USERNAME__`/`__DOCKERHUB_PASSWORD__`) are replaced at bootstrap from `cluster-credentials` and applied via containerd `registry.configs.*.auth` for docker.io/registry-1.docker.io to avoid Docker Hub rate limits. `config_path` is intentionally not set because containerd ignores `registry.configs` when `config_path` is defined.
- Delete/recreate: `task bootstrap:delete` / `task bootstrap:recreate`.
- Env overrides honored by bootstrap: `MULTUS_PARENT_IFACE`, `MULTUS_PARENT_SUBNET`, `MULTUS_PARENT_GATEWAY`, `MULTUS_PARENT_IP_RANGE` (document when used).
- Secrets: `cluster-credentials.template.yaml` carries `oauth2_proxy_client_secret` and `oauth2_proxy_cookie_secret` (32-byte). OAuth2 Proxy client ID is hardcoded to `oauth2-proxy` in its ExternalSecret template. Secrets now also include Docker Hub creds (`dockerhub_username`, `dockerhub_password`) used to write containerd registry auth during bootstrap.

## Argo CD & Apps
- ApplicationSet uses go-template and orders Applications via `argocd.argoproj.io/sync-wave` (taken from `sync.wave`; lower = earlier). RollingSync and progressive syncs are **not** used; remove any legacy `rollout.*` fields when touching app configs.
- Current wave ladder (use these numbers when adding apps):
  - `-5` base system + CRDs: argocd, coredns, metrics-server, multus, local-path-provisioner, cert-manager (controller/CRDs), external-secrets, gateway-api, istio-base, metacontroller, reloader
  - `-4` metacontroller consumers / DNS publishers / sensors: homelab-controller, external-dns-{internal,external}, falco, trivy-operator
  - `-3` service mesh + authn: istio (also owns its gateway Issuers/Certificate and ExternalSecret), dex, oauth2-proxy
  - `-2` edge: cloudflared
  - `-1` time-sync webhook: k8tz
- `0` default catch-all (all other apps)
- PKI manifests for Istio (gateway Issuers, wildcard cert, Cloudflare ExternalSecret) live in `apps/platform-system/istio/manifests`; `apps/platform-system/cert-manager` only installs the controller/CRDs.
- Destination namespace defaults to the group directory unless overridden in `config.yaml`.
- ApplicationSet hardcodes `ServerSideApply=true` for every app (per-app `sync.serverSideApply` is removed).
- ApplicationSet sync options now omit `PruneLast`/`RespectIgnoreDifferences`; no global `ignoreDifferences` block—trust SSA/diffs.
- Argo CD controller runs with server-side diff enabled (`controller.diff.server.side=true`).
- Argo CD configmap ignores status-only changes for all resources (`resource.ignoreResourceUpdatesEnabled=true` + `resource.customizations.ignoreResourceUpdates.all` jsonPointer `/status`).
- ValidatingWebhookConfiguration caBundle/failurePolicy drift is ignored globally via `resource.customizations.admissionregistration.k8s.io/ValidatingWebhookConfiguration` jqPathExpressions in Argo CD values.
- k8tz webhook TLS uses a namespace-scoped Issuer `k8tz-webhook-issuer` (see `apps/kube-system/k8tz/manifests/k8tz-webhook-issuer.issuer.yaml`); k8tz values enable cert-manager webhook issuer.
- oauth2-proxy is pinned to chart 9.0.1 with OIDC groups support, cookie-based sessions, and gateway ext-auth applied only on HTTPS listeners (auth/id hosts and `/oauth2/*` bypassed). Shared wildcard `/oauth2/*` route removed; only auth.{external,internal} routes remain.
- Gateway ext-auth forwards identity headers (`x-auth-request-user`, `x-auth-request-email`, `x-auth-request-groups`) via Istio `headersToUpstreamOnAllow` with oauth2-proxy `set-xauthrequest` enabled, while keeping `Authorization`/access-token passthrough disabled and legacy `X-Forwarded-*`/Basic auth headers suppressed. Backends consume only the x-auth-request identity headers.
- Dex runs with static config in `values.yaml` (no metacontroller, no external connectors). Update the static password hash in `dex-credentials` ExternalSecret.
- Metacontroller renders Gatus configs; edit templates under `manifests/homelab-controller/`, never the generated `*-generated-config` ConfigMaps. Keep the implementations structurally aligned (only app-specific diffs).
- Homepage replaces Hajimari. External HTTPRoutes you want visible on the dashboard must carry `gethomepage.dev/enabled: "true"`, plus `gethomepage.dev/name`, `gethomepage.dev/group`, and `gethomepage.dev/icon` (use iconify values such as `mdi:...`). Default group is the namespace title-cased. Keep the existing `external-dns` labels.
- Enable Gatus by labeling Services `gatus.edgard.org/enabled: "true"`.
- Gateway API CRDs are installed via the `gateway-api` app from kubernetes-sigs/gateway-api releases. The CRDs file is downloaded from GitHub and stored in manifests; update by downloading the new version's `standard-install.yaml`.
- Istio ingress uses Gateway API with two Gateways: `gateway-external` (wildcard + root over HTTPS, external-dns target tunnel.edgard.org) and `gateway-internal` (wildcard + root, macvlan IP 192.168.1.241). We rely on the built-in `istio` GatewayClass (no custom GatewayClass objects). Gateway API resources now live in `platform-system/istio` alongside istiod; the Istio controller auto-provisions the data-plane Deployments/Services (Service type forced to ClusterIP via `gateway.istio.io/serviceType: ClusterIP`). OIDC is enforced via the ext-auth `oauth2-proxy` provider (Dex IdP, cookie domain `.edgard.org`). Sidecar injector is disabled (`sidecarInjectorWebhook.enabled=false`, `global.proxy.autoInject=disabled`) to keep the deployment gateway-only. Istio charts pull from `https://istio-release.storage.googleapis.com/charts` (base/istiod).
- Istio webhooks: controller mutates failurePolicy/caBundle; Argo ignores those fields on `istiod-default-validator` and `istio-validator-platform-system` to avoid drift.
- CoreDNS override lives at `apps/kube-system/coredns/values.yaml`; it forwards `edgard.org` to Unifi (192.168.1.1) but pins `id.edgard.org` to the internal Istio gateway IP (192.168.1.241) for in-cluster OIDC.

## Storage
- Reuse Kind’s built-in local-path-provisioner; we only manage config + StorageClasses under `apps/local-path-storage/local-path-provisioner/manifests`.
- ConfigMap `local-path-config` (namespace `local-path-storage`) sets node paths `/mnt/spool/appdata` and `/mnt/dpool`; pathPattern `{{ .PVC.Namespace }}/{{ .PVC.Name }}` for fast, `{{ .PVC.Name }}` for bulk.
- StorageClasses:
  - `local-fast` (default): RWO, `WaitForFirstConsumer`, base `/mnt/spool/appdata` with `namespace/claim` subpaths.
  - `local-bulk`: RWO, base `/mnt/dpool`, pathPattern claim name (so PVC `media` maps to `/mnt/dpool/media`).
- Media PVC is dynamic on `local-bulk` (`media` in namespace `media`, maps to `/mnt/dpool/media`).
- Kind’s built-in `standard` StorageClass is annotated `is-default-class=false` via `standard.storageclass.yaml` to avoid multiple defaults.
- Bootstrap also disables any default StorageClass created by Kind (patches `storageclass.kubernetes.io/is-default-class=false` before Argo sync) so `local-fast` becomes the sole default.
- Kopia repo and www now use dynamic PVCs on `local-bulk` (sizes set in their values files); move host data into the provisioned paths when migrating.
- Base paths `/mnt/spool/appdata` and `/mnt/dpool` must exist on the Kind host; worker already mounts `/mnt/spool` and `/mnt/dpool`.
- Char devices `/dev/net/tun` and `/dev/ttyUSB0` remain hostPath mounts where needed; kopia keeps hostPath `/mnt/spool/appdata` for backup source coverage.
- Helper scripts in repo root:
  - `migrate-pvc-data.sh` (dry-run by default, use `DRY_RUN=0`) to rsync old hostPath data into new PVC paths.
  - `cleanup-old-hostpaths.sh` (dry-run by default) to remove legacy hostPath directories after migration.

## Commands
- Lint/format YAML: `task lint` (prettier ➜ yamlfmt ➜ yamllint).
- Secrets: `task secrets:create-key`, `task secrets:edit`, `task secrets:apply` (decrypts and applies to current kube context).
- Argo resync without CLI: `task argo:sync app=name` (omit `app` to refresh all).
- Argo UI port-forward: `task argo:pf` (forwards `svc/argocd-server` on 8080→80).
- Renovate: `.renovaterc.json5` tracks Helm charts in `apps/*/*/config.yaml`, Kind node images, WASM plugins in `apps/*/*/manifests/*.wasmplugin.yaml` (docker datasource), and Gateway API CRDs version (github-releases datasource).
- Istio charts are pinned to the `platform-system` namespace via `global.istioNamespace`/`configRootNamespace`; validation failure policy is set to `Ignore`. Argo no longer ignores Istio webhook CA bundle drift (expect SSA to update it).
- Terraform: `task tf:plan|tf:apply|tf:validate|tf:clean` (default dir `terraform`). Env required: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` (B2 backend), `CLOUDFLARE_API_TOKEN`, `TF_VAR_cloudflare_zone_id`. `.envrc` provides local values—do not commit rotations here.

## Coding Style & Patterns
- YAML: 2-space indent; logical ordering (metadata → spec/values); filenames track chart/app names; keep `manifests/` dirs present even if empty.
- Python (`bootstrap/scripts/`): type hints, f-strings, existing logging style; run `python3 -m compileall bootstrap/scripts` after edits.
- Conventional Commits (`feat:`, `fix:`, `refactor:`, `chore(deps):`, etc.). Keep PRs focused; note validation steps (lint, Kind/Argo checks) and any manual rollout actions.
- Follow existing organization/naming: app folder name = Argo Application name; destination namespace defaults to the group folder; filenames mirror chart/app; metacontroller implementations stay visually identical across apps except for intentional spec/label/selectors; `sync.wave` must align with the wave ladder above. If you must diverge, document the rationale and update `.agents.md` + README in the same change.

## Resource Naming Conventions
All Kubernetes resources follow consistent naming patterns. Filename must always match `metadata.name`.

### Manifest Files
- Pattern: `{app}-{descriptor}.{kind}.yaml`
- The `{app}` prefix must match the app directory name
- The `{descriptor}` describes what the resource does/is
- The `{kind}` suffix is the lowercase Kubernetes kind
- Examples: `istio-credentials.externalsecret.yaml`, `gateway-external.gateway.yaml`

### Secrets (ExternalSecrets)
- Pattern: `{app}-credentials`
- All ExternalSecrets create secrets with `-credentials` suffix
- Exception: `argocd-secret` (ArgoCD's built-in secret, we merge into it with `creationPolicy: Merge`)
- Examples: `kopia-credentials`, `oauth2-proxy-credentials`, `dex-credentials`

### TLS Certificate Secrets
- Pattern: `{app}-{descriptor}-tls`
- Example: `gateway-wildcard-tls` (created by istio Certificate resource)

### Generated ConfigMaps (homelab-controller)
- Pattern: `{app}-generated-config`
- These are auto-generated by homelab-controller from GatusConfig CRs
- Examples: `gatus-generated-config`
- Never edit these directly; modify the source CR's `spec.base` instead

### Issuers (istio)
- Pattern: `gateway-issuer-{environment}`
- Examples: `gateway-issuer-production`, `gateway-issuer-staging`

### Gateways (Istio)
- Pattern: `gateway-{scope}`
- Examples: `gateway-external`, `gateway-internal`
- Related resources (ReferenceGrant, ConfigMap) use same prefix: `gateway-external.referencegrant.yaml`

### HTTPRoutes
- Pattern: `{app}-{purpose}` or `gateway-{purpose}`
- Examples: `oauth2-proxy-auth-external`, `gateway-https-redirect`, `gateway-root-redirect`

### ServiceAccounts & fullnameOverride
- Must match the app directory name exactly
- Examples: `external-dns-external`, `external-secrets`, `metrics-server`

### ClusterSecretStore
- Single store: `external-secrets-store`
- All ExternalSecrets reference this via `secretStoreRef.name`

### Custom Resource Definitions
- Pattern: `{plural}.{group}` (FQDN style)
- Examples: `gatusconfigs.homelab.edgard.org`

### Summary Table
| Resource Type | Pattern | Example |
|---------------|---------|---------|
| ExternalSecret | `{app}-credentials` | `gateway-credentials` |
| TLS Secret | `{app}-{desc}-tls` | `gateway-wildcard-tls` |
| Generated ConfigMap | `{app}-generated-config` | `gatus-generated-config` |
| Gateway | `gateway-{scope}` | `gateway-external` |
| Issuer | `{app}-issuer-{env}` | `gateway-issuer-production` |
| HTTPRoute | `{app}-{purpose}` | `oauth2-proxy-auth-external` |
| CRD | `{plural}.{group}` | `gatusconfigs.homelab.edgard.org` |

## Testing & Safety
- Baseline: `task lint`.
- Targeted manifest tweaks (rare): use `kubectl diff -f <path>` for dry-run inspection only. Do not `kubectl apply`/`kubectl patch` Argo-managed resources—Argo sync will overwrite; make changes in Git and let Argo reconcile.
- When updating Argo Applications, confirm chart `targetRevision` matches the intended release to avoid drift.
- Never commit decrypted secrets; `.sops.agekey` stays untracked/local.
