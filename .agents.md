# Repository Guidelines

## Project Structure & Module Organization
- `cluster/config/`: Kind cluster config plus SOPS-encrypted secrets and template (`cluster-config.yaml`, `cluster-secrets.sops.yaml`, `cluster-secrets.template.yaml`). Age key is expected at repo root as `.sops.agekey`.
- `kubernetes/argocd/`: Argo CD bootstrap manifests and application definitions.
- `kubernetes/apps/`: Domain-grouped apps (edge-services, platform-system, ops, media, home-automation, arc, argocd). Each folder contains the Helm values/manifests for that component.
- `scripts/bootstrap.py`: Automation entrypoint for creating/deleting the Kind cluster and installing Argo CD/Multus.
- `Makefile`: Task runner for bootstrap, Kind management, secrets, linting, and syncs. Run `make help` for a quick list.
- `.github/workflows/renovate.yaml`: Renovate automation for dependency updates.

## Metacontrollers
- Dynamic configs for Hajimari, Gatus, and Dex are rendered by metacontroller CompositeControllers (manifests under each app’s `manifests/metacontroller/`). Generated ConfigMaps: `hajimari-config-generated`, `gatus-config-generated`, `dex-config-generated`.
- Update config templates/CR specs (`HajimariConfig`, `GatusConfig`, `DexConfig`) instead of editing generated ConfigMaps; init containers are not used for these apps.

## Build, Test, and Development Commands
- `make bootstrap`: Provision the Kind cluster using `cluster/config/cluster-config.yaml`, then install Argo CD and apps.
- `make bootstrap-delete` / `make bootstrap-recreate`: Tear down or rebuild the managed cluster.
- `make kind-create | kind-delete | kind-status`: Manage a local Kind cluster with the repo config.
- `make secrets-create-key`: Generate an Age key at `.sops.agekey`; `make secrets-edit` to create/edit encrypted secrets; `make secrets-apply` to decrypt and apply them.
- `make lint`: Format YAML with Prettier + yamlfmt and lint with yamllint.
- `make argo-sync ARGOCD_SELECTOR=key=value`: Force Argo CD Application refresh (limit scope with a selector when needed).

## Coding Style & Naming Conventions
- YAML: 2-space indent; order fields logically (metadata → spec/values); filenames track chart/app names.
- Helm/Argo: Keep Application names aligned with folder scope (e.g., `edge-services-hajimari`).
- Python (`scripts/bootstrap.py`): Maintain type hints, f-strings, and existing logging style. Run `python3 -m compileall scripts` if you modify it.
- Formatting tools: Prettier, yamlfmt, yamllint. Run `make lint` before committing.
- New apps: add Hajimari discovery labels on the external `HTTPRoute` (`hajimari.edgard.org/enabled: "true"`, `hajimari.edgard.org/icon: <mdi icon without "mdi:">`) and enable Gatus by labeling the Service (`gatus.edgard.org/enabled: "true"`).

## Testing Guidelines
- Core check is manifest formatting/lint (`make lint`).
- For cluster changes, validate locally: `make kind-create`, then `kubectl get pods -A` and `kubectl diff -f <file>` before pushing.
- When updating Argo Applications, confirm chart `targetRevision` matches the intended release to avoid drift.

## Security & Configuration Tips
- Do not commit decrypted secrets. Keep `cluster/config/cluster-secrets.sops.yaml` encrypted; `.sops.agekey` stays local and untracked.
- Bootstrap honors env overrides (`MULTUS_PARENT_IFACE`, subnet, gateway). Document any overrides in your PR.

## Commit & Pull Request Guidelines
- Use Conventional Commits as seen in history (`refactor(argo): ...`, `chore(deps): ...`, `fix(multus): ...`).
- Keep PRs focused; include what changed, validation steps (lint, Kind/Argo checks), and any manual rollout actions (`make argo-sync`, reapplying secrets).
