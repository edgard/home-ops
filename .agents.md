# Repository Guidelines

## Documentation Maintenance
- Keep this file and `README.md` aligned on bootstrap behavior, Flux topology, namespace ordering, and validation workflows. `README.md` stays concise for new readers and must never reference `.agents.md`; this file owns all of the detail, so update both together whenever those flows change.
- Document every repository change that affects behavior, topology, conventions, or automation here immediately so contributors always land on the latest instructions.
- When modifying code or manifests, prefer the existing patterns and directory conventions in this repo (naming, layout, annotations, dependsOn structure, etc.) so future diffs stay predictable—introduce new structures only when necessary and mirror them everywhere they apply.
- Scrub sensitive data before committing. Secrets, tokens, credentials, VPN material, and chat IDs belong in `cluster-secrets.sops.yaml`, not in documentation.

## Platform & bootstrap
- `cluster/config/cluster-config.yaml` defines a two-node Kind v1.34.0 cluster (control-plane + worker). The worker node mounts `/mnt/spool`, `/mnt/dpool`, `/dev/net/tun`, and `/dev/ttyUSB0` from the host so workloads can reuse local storage, tun devices, and USB radios.
- `scripts/bootstrap.py` (run via `make bootstrap`) enforces prerequisites (`docker`, `kind`, `kubectl`, `helm`, `python3` + `pyyaml`, `sops`, `age`), ensures the Docker context `kind-<cluster>` exists, creates or upgrades Kind from the repo config, attaches worker nodes to the macvlan `kind-<cluster>-net`, patches Kindnet to drop resource requests, sets the kubeconfig context, decrypts/applies `cluster/config/cluster-secrets.sops.yaml`, installs `flux-operator@0.33.0`, creates the optional `flux-sync` Secret when Git creds are present, renders the FluxInstance manifest from `infra/flux-system/flux-instance/app/helmrelease.yaml`, waits for that instance to become Ready, and stops so Flux can reconcile `cluster/flux` on its own.
- Override LAN wiring before bootstrapping by exporting `MULTUS_PARENT_IFACE`, `MULTUS_PARENT_SUBNET`, `MULTUS_PARENT_GATEWAY`, or `MULTUS_PARENT_IP_RANGE`. Those feed the macvlan network (`kind-<cluster>-net`) that Multus workloads use for static LAN IPs.
- Helper targets are single-cluster scoped—there is no `CLUSTER` override. Update `cluster/config`, `cluster/flux`, and the Flux manifests directly when the bootstrap flow changes.

## Layout & conventions
- `cluster/config/` holds the Kind configuration plus the encrypted SOPS bundle. `cluster/flux/ks.yaml` defines the root `cluster-infra` and `cluster-apps` Flux Kustomizations (both in `flux-system`) and injects the shared HelmRelease install/upgrade patch so controllers share identical retry/rollback behavior.
- Infrastructure controllers live under `infra/<namespace>/<app>/`. `infra/flux-system` owns the Flux operator/instance; `infra/platform-system` contains Multus, External Secrets, metrics-server, Reloader, cert-manager, Envoy Gateway, both External DNS controllers, cloudflared, and Dex. Each namespace folder includes `namespace.yaml`, `app/` manifests, and a co-located `ks.yaml` so Flux manages labels, annotations, and reconciliation order.
- Applications live under `apps/<namespace>/<app>/` with the same structure: a namespace-level `kustomization.yaml`, per-app directories that contain `app/helmrelease.yaml`, supporting manifests (Gateways, ExternalSecrets, CronJobs, etc.), an `app/kustomization.yaml`, and a namespace-scoped `<namespace>-<app>` Flux `Kustomization`.
- Bootstrap still creates `platform-system` and ensures `flux-system` exists, but their metadata is managed by Flux via the manifests under `infra/`.
- Every workload keeps a co-located `ks.yaml` named `<namespace>-<app>` so `flux get kustomizations` output stays readable. Keep HelmReleases, repository objects, ExternalSecrets, HTTPRoutes/SecurityPolicies, DNSEndpoints, and supporting manifests under the same `app/` directory.

## Secrets & ExternalSecrets
- Copy `cluster/config/cluster-secrets.template.yaml` to `cluster/config/cluster-secrets.sops.yaml`, fill the placeholders, and manage the encrypted bundle with `make secrets-create-key`, `make secrets-edit`, and `make secrets-apply`. Bootstrap decrypts the bundle on the fly when External Secrets needs it.
- `.sops.agekey` lives in the repo root (gitignored). Export `SOPS_AGE_KEY_FILE=$(pwd)/.sops.agekey` so Make targets and bootstrap can decrypt without extra flags.
- `infra/platform-system/external-secrets/ks.yaml` installs ESO into `platform-system`; `infra/platform-system/external-secrets/config/clustersecretstore.yaml` points at the decrypted `platform-system/cluster-secrets` Secret. Always run `make secrets-apply` before Flux reconciles ESO so the backing secret exists.
- `infra/platform-system/envoy-gateway/config/envoy-oidc-client.clusterexternalsecret.yaml` fans the `envoy_gateway_oidc_client_secret` into every namespace labeled `envoy-gateway.edgard.org/oidc-client: "true"` (ops, media, edge-services, home-automation, platform-system). Label new namespaces before shipping Dex-backed SecurityPolicies.
- `infra/platform-system/dex/app/dex-static-password.externalsecret.yaml` pulls `dex_admin_password_hash` into the `dex-static-password` Secret so Dex can load its local user hash via `hashFromEnv`.
- Required keys in `cluster-secrets.sops.yaml` (see the template for exact names):
  - Flux sync credentials (`flux_sync_username`/`flux_sync_password`) whenever the Git repo is private.
  - ARC GitHub App material (`arc_runners_github_app_id`, `arc_runners_github_app_installation_id`, `arc_runners_github_app_private_key`).
  - qbittorrent WireGuard material (`qbittorrent_server_cities`, `qbittorrent_wireguard_addresses`, `qbittorrent_wireguard_private_key`).
  - Unpackerr API keys (`unpackerr_radarr_api_key`, `unpackerr_sonarr_api_key`).
  - DNS + TLS credentials (`cert_manager_cloudflare_api_token`, `external_dns_cloudflare_api_token`, `external_dns_unifi_api_key`).
  - Access tokens (`cloudflared_tunnel_token`, `envoy_gateway_oidc_client_secret`).
  - Dex static password hash (`dex_admin_password_hash`). Update the inline Dex config (redirect URIs, connectors, etc.) in `infra/platform-system/dex/app/helmrelease.yaml`.
  - Service credentials (`kopia_password`, `gatus_telegram_token`, `gatus_telegram_chat_id`, `changedetection_api_key`, `changedetection_notification_url`).

## Networking & access
- Bootstrap creates a Docker macvlan network named `kind-<cluster>-net` and attaches the worker nodes so Multus can expose LAN workloads. Host-side the network defaults to parent `br0`. Inside each node, the `lan-macvlan` NAD (`infra/platform-system/multus/config/lan-macvlan.yaml`) points at `eth1`, runs in bridge mode, and uses static IPAM. Current static leases: Envoy internal (192.168.1.241/24, `02:42:c0:a8:01:f1`), Jellyfin (192.168.1.245/24, `02:42:c0:a8:01:f5`), and Home Assistant (192.168.1.246/24, `02:42:c0:a8:01:f6`). Reserve DHCP entries before adding new Multus workloads.
- `infra/platform-system/envoy-gateway` (chart v1.6.0) installs GatewayClasses, `external`/`internal` Gateways, EnvoyProxy definitions (internal carries the Multus annotation), HTTP→HTTPS RequestRedirect routes, ReferenceGrants, shared Client/Backend policies, Envoy services, and the ClusterExternalSecret for the OIDC client.
- `infra/platform-system/cert-manager` (chart v1.19.1) deploys cert-manager plus the `letsencrypt-cloudflare` ClusterIssuer and `wildcard-edgard-org` Certificate so both Gateways terminate TLS via DNS-01.
- `infra/platform-system/external-dns-external` (Cloudflare, controller v0.19.0) watches HTTPRoutes + DNSEndpoints labeled `external`. `infra/platform-system/external-dns-internal` reuses the same chart with the UniFi webhook (`ghcr.io/kashalls/external-dns-unifi-webhook:v0.7.0`) for split-horizon records tagged `internal`.
- `infra/platform-system/cloudflared` runs two replicas of `cloudflare/cloudflared:2025.11.1`, loads the tunnel token from `cloudflared-secret`, tunnels `*.edgard.org` and `edgard.org` to `envoy-external`, exposes readiness metrics on port 8080, and publishes a `DNSEndpoint` for `tunnel.edgard.org`. Reloader annotations make sure config/secret changes recycle the pods.
- Dex (`infra/platform-system/dex`) exposes `id.edgard.org`, serves config from the HelmRelease-managed ConfigMap, keeps sqlite data on `/mnt/spool/appdata/dex`, and reads secrets via env vars (`envoy-oidc-client` + `dex-static-password`). Envoy SecurityPolicies reference Dex directly—no oauth2-proxy hop in between.
- Every workload ships an internal HTTPRoute (`external-dns.edgard.org/scope: internal`) that targets the `internal` Gateway without auth. External HTTPRoutes target the `external` Gateway, add `external` scope, and attach a `gateway.envoyproxy.io/v1alpha1` `SecurityPolicy` referencing Dex unless the app has a native login flow (currently Atuin and Home Assistant). When you add a new Dex-protected route, remember to add the callback URL to the Dex config block in `infra/platform-system/dex/app/helmrelease.yaml`.

## Namespaces & workloads
- **kube-system** – untouched; managed by Kind.
- **flux-system** – Holds `flux-operator`, the `flux` FluxInstance, the GitRepository (`flux-system` source), and the root `cluster-infra`/`cluster-apps` Kustomizations. Bootstrap renders the Helm releases once, waits for the FluxInstance to report Ready, and Flux manages itself after that.
- **platform-system** – Runs Multus (chart + `lan-macvlan` NAD), External Secrets (`clustersecretstore` pointing at `platform-system/cluster-secrets`), metrics-server (patch drops CPU/memory requests and enables `--kubelet-insecure-tls`), Reloader, cert-manager (`letsencrypt-cloudflare` issuer + `wildcard-edgard-org` certificate), Envoy Gateway (chart + config tree), both External DNS controllers, cloudflared (DNSEndpoint + tunnel deployment), and Dex. The namespace owns the shared `envoy-oidc-client` Secret and the decrypted `cluster-secrets` Secret that backs ESO.
- **ops** – `apps/ops/gatus` runs `ghcr.io/twin/gatus:v5.32.0`, stores sqlite data under `/mnt/spool/appdata/gatus`, renders its full config via ConfigMap, loads Telegram settings from the `gatus-telegram` ExternalSecret, and publishes Dex-protected external/internal HTTPRoutes at `status.edgard.org`. Checks cover Envoy, Cloudflared, Flux, Dex, DNS resolvers, WAN connectivity, and every app namespace (home automation, media, edge-services, etc.). `apps/ops/kopia` mounts `/mnt/spool/appdata/kopia` (config/cache), `/mnt/dpool/backup/kopia` (repository), and `/mnt/spool/appdata` (read-only `/data`), uses a privileged init container to create or connect the repo using `kopia_password`, and exposes Dex-protected HTTPRoutes at `kopia.edgard.org`.
- **home-automation** – Mosquitto uses hostPaths under `/mnt/spool/appdata/mosquitto` for config/data/log storage. Zigbee2MQTT depends on Mosquitto, runs privileged, joins supplemental group 20 (`dialout`), binds `/dev/ttyUSB0`, and stores data in `/mnt/spool/appdata/zigbee2mqtt`. Home Assistant runs on Multus (`192.168.1.246/24`, `02:42:c0:a8:01:f6`), persists under `/mnt/spool/appdata/home-assistant`, and exposes paired HTTPRoutes at `home-assistant.edgard.org`; it currently relies on Home Assistant’s native auth (no SecurityPolicy) so add Dex integration deliberately if that changes.
- **media** – LinuxServer apps (`bazarr`, `radarr`, `sonarr`, `prowlarr`) share `PUID=568`, `PGID=568`, `UMASK=022`, mount `/mnt/spool/appdata/<name>` plus `/mnt/dpool/media`, and ship dual HTTPRoutes (external Dex-protected + internal). `qbittorrent` runs alongside a privileged `qmcgaw/gluetun` sidecar fed by the `qbittorrent-gluetun` ExternalSecret and mounts `/dev/net/tun`. `radarr` and `sonarr` depend on `media-qbittorrent`; `prowlarr` depends on `media-flaresolverr`. `jellyfin` forces amd64 scheduling, runs on Multus (`192.168.1.245/24`), and shares `/mnt/dpool/media`. `recyclarr` (supercronic) syncs Radarr/Sonarr profiles, while `unpackerr` watches `/mnt/dpool/media` using API keys from the `unpackerr` Secret.
- **edge-services** – `nginx` serves `edgard.org`/`www.edgard.org` from `/mnt/dpool/www` with HTTPRoutes on both Gateways. `echo` exposes Dex-protected external routes plus an auth-free internal route pointing at `echo.edgard.org`. `atuin` runs the bjw-s app-template chart (v4.4.0) with sqlite on `/mnt/spool/appdata/atuin` and intentionally leaves both HTTPRoutes auth-free because the CLI handles login. `changedetection` (bjw-s app-template v4.4.0 + `ghcr.io/dgtlmoon/changedetection.io:0.51.1`) keeps `/datastore` on `/mnt/spool/appdata/changedetection`, runs alongside a `browser-sockpuppet-chrome` sidecar so the UI can spawn a Chrome/WebDriver session, exposes Dex-protected and LAN-only `changedetection.edgard.org` HTTPRoutes, mounts secrets from `changedetection-credentials`, and includes the `changedetection-notifications` CronJob that refreshes `/api/v1/notifications` every six hours using the API key + notification URL from `cluster-secrets`.
- **arc** – `apps/arc/controller` installs `gha-runner-scale-set-controller@0.13.0`. `apps/arc/runners` defines the `arc-homelab` scale set (chart 0.13.0), references `github.com/edgard/home-ops`, loads credentials from the `arc-runners-secret` ExternalSecret, runs an init container to copy runner externals, and adds a privileged `docker:29-dind` sidecar that shares `_work`, `_dind`, and `dind-externals` emptyDirs with the runner. The HelmRelease depends on the controller so CRDs exist first.

## Flux dependency graph
`cluster-infra` renders `infra/kustomization.yaml` so shared controllers reconcile first. `cluster-apps` depends on it before applying `apps/kustomization.yaml`. Namespace gates are gone; each workload owns its own `dependsOn` entries.

**Infrastructure Kustomizations**

| Namespace | Kustomization | Depends on |
| --- | --- | --- |
| `flux-system` | `flux-instance` | `flux-operator` |
| `flux-system` | `cluster-apps` | `cluster-infra` |
| `platform-system` | `platform-system-multus` | `flux-instance` |
| `platform-system` | `platform-system-multus-config` | `platform-system-multus` |
| `platform-system` | `platform-system-external-secrets` | `platform-system-multus-config` |
| `platform-system` | `platform-system-external-secrets-config` | `platform-system-external-secrets` |
| `platform-system` | `platform-system-metrics-server` | `platform-system-multus-config` |
| `platform-system` | `platform-system-reloader` | `platform-system-multus-config` |
| `platform-system` | `platform-system-cert-manager` | `platform-system-external-secrets-config` |
| `platform-system` | `platform-system-cert-manager-config` | `platform-system-cert-manager` |
| `platform-system` | `platform-system-envoy-gateway` | `platform-system-cert-manager-config` |
| `platform-system` | `platform-system-envoy-gateway-config` | `platform-system-envoy-gateway`, `platform-system-external-secrets-config` |
| `platform-system` | `platform-system-external-dns-external` | `platform-system-envoy-gateway-config` |
| `platform-system` | `platform-system-external-dns-internal` | `platform-system-envoy-gateway-config` |
| `platform-system` | `platform-system-cloudflared` | `platform-system-external-dns-external` |
| `platform-system` | `platform-system-dex` | `platform-system-envoy-gateway-config` |

**Application Kustomizations**

| Namespace | Kustomization | Depends on |
| --- | --- | --- |
| `home-automation` | `home-automation-zigbee2mqtt` | `home-automation-mosquitto` |
| `home-automation` | `home-automation-home-assistant` | `home-automation-zigbee2mqtt` |
| `media` | `media-radarr` | `media-qbittorrent` |
| `media` | `media-sonarr` | `media-qbittorrent` |
| `media` | `media-prowlarr` | `media-flaresolverr` |
| `arc` | `arc-runners` | `arc-controller` |

Other workloads reconcile independently.

## Build, Test, and Development Commands
- `make bootstrap` / `make bootstrap-delete` / `make bootstrap-recreate` – create, delete, or rebuild the Kind + Flux environment via the helper script.
- `make kind-create` / `kind-delete` / `kind-recreate` / `kind-status` – operate Kind directly when you do not need the bootstrap flow.
- `make secrets-create-key` – create `.sops.agekey` (prints the age recipient) before editing the encrypted bundle.
- `make secrets-edit` / `make secrets-apply` – open or apply the encrypted `cluster-secrets.sops.yaml` file with SOPS.
- `make flux-reconcile` – runs `flux reconcile kustomization flux-system --namespace flux-system --with-source` so the bootstrap tree reapplies; Flux then rolls out `cluster-infra`/`cluster-apps` per their `dependsOn` graph.
- `make lint` – formats every `*.yml`/`*.yaml` file with Prettier, runs `yamlfmt`, and then lints the tree with `yamllint`. This replaces the old `make yaml-check` target—run it before pushing changes.
- Use the Flux CLI directly (`flux get kustomizations -A`, `flux get sources git -n flux-system`) or `kubectl -n <namespace> describe kustomization/<name>` for per-app debugging—there are no extra helper targets for those views.

## Testing Guidelines
- Treat `make bootstrap` as the integration test. Wait for `flux get kustomizations cluster-infra cluster-apps -n flux-system` plus `flux get kustomizations -n platform-system` (or the relevant namespaces) to show `Ready` before calling a change good.
- After structural edits (new namespace, HelmRelease, or Flux wiring) rerun `make bootstrap` or at least `make flux-reconcile` so Flux rebuilds the source artifact and reapplies the tree.
- For chart bumps, bootstrap from your branch and follow `flux get kustomizations` / `kubectl -n <namespace> describe kustomization/<name>` until the affected releases reconcile cleanly. All debugging flows go through Flux (ArgoCD is not used here).

## Security & Configuration Tips
- Never commit plaintext secrets. Keep `cluster-secrets.sops.yaml` encrypted and `.sops.agekey` private. If you relocate the key, update `.sops.yaml` and re-encrypt before committing.
- Populate `flux_sync_username` / `flux_sync_password` when the Git repo is private so bootstrap can create the `flux-sync` Secret referenced by the FluxInstance Helm values.
- Regenerate Dex bcrypt hashes with `htpasswd -nbB user pass`, update `dex_admin_password_hash` in `cluster-secrets.sops.yaml`, adjust the inline Dex config (redirect URIs/users) in `infra/platform-system/dex/app/helmrelease.yaml`, then reapply the secrets bundle and reconcile Flux.
- Sanitize command output (`flux get kustomizations`, `kubectl -n platform-system get kustomizations`, etc.) before sharing—redact hostnames, tokens, and chat IDs.

## Dependency Automation
- Renovate tracks container images, Helm charts, the Kind node image, and GitHub Actions workflows. Review each PR like any other change, run `make bootstrap`/`make flux-reconcile` as appropriate, and merge once the touched Kustomizations report `Ready`.
- When you add a new registry, ship the co-located `app/ocirepository.yaml` (or `app/helmrepository.yaml`) so Renovate can track versions automatically.

## Implementation guidelines
- Keep filenames predictable (`app/helmrelease.yaml`, `app/ocirepository.yaml`, `app/gateway.yaml`, `app/<name>.externalsecret.yaml`, etc.) so tooling and contributors can navigate quickly.
- When adding a workload, create `apps/<namespace>/<app>/app/helmrelease.yaml` (or `infra/<namespace>/<app>/app/helmrelease.yaml` for infrastructure controllers) plus any supporting manifests, then register a `<namespace>-<app>` Flux `Kustomization` next to it with the right `dependsOn` entries.
- Python helpers (see `scripts/bootstrap.py`) should stay dependency-light, rely on `pathlib`/`subprocess`, reuse the existing logging helpers, and prioritize clarity over cleverness.
