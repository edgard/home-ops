# Repository Guidelines

## Project Structure & Module Organization
- `bootstrap/config/`: Kind cluster config plus SOPS-encrypted secrets and template (`cluster-config.yaml`, `cluster-secrets.sops.yaml`, `cluster-secrets.template.yaml`). Age key is expected at repo root as `.sops.agekey`.
- `argocd/`: Argo CD bootstrap (`root.app.yaml`), namespaces (`namespaces/*.namespace.yaml`), and a single ApplicationSet (`appsets/apps.appset.yaml`) that discovers apps.
- `apps/`: Domain-grouped apps (edge-services, platform-system, ops, media, home-automation, arc, argocd). Each app folder contains `config.yaml`, `values.yaml`, and optional `manifests/`.
- `bootstrap/scripts/bootstrap.py`: Automation entrypoint for creating/deleting the Kind cluster and installing Argo CD/Multus.
- `Makefile`: Task runner for bootstrap, Kind management, secrets, linting, and syncs. Run `make help` for a quick list.
- `.github/workflows/renovate.yaml` + `.renovaterc.json5`: Renovate automation for dependency updates.

## Metacontrollers
- Dynamic configs for Hajimari, Gatus, and Dex are rendered by metacontroller CompositeControllers (manifests under each app’s `manifests/metacontroller/`). Generated ConfigMaps: `hajimari-config-generated`, `gatus-config-generated`, `dex-config-generated`.
- Update config templates/CR specs (`HajimariConfig`, `GatusConfig`, `DexConfig`) instead of editing generated ConfigMaps; init containers are not used for these apps.
- Keep the three metacontroller implementations (scripts, CompositeController, Deployment/Service/RBAC) visually identical except for app-specific logic/labels/selectors/CR fields; if you diff them side-by-side, only the necessary app-specific differences should appear.

## Build, Test, and Development Commands
- `make bootstrap`: Provision the Kind cluster using `bootstrap/config/cluster-config.yaml`, then install Argo CD and apps.
- `make bootstrap-delete` / `make bootstrap-recreate`: Tear down or rebuild the managed cluster.
- `make kind-create | kind-delete | kind-status`: Manage a local Kind cluster with the repo config.
- `make secrets-create-key`: Generate an Age key at `.sops.agekey`; `make secrets-edit` to create/edit encrypted secrets; `make secrets-apply` to decrypt and apply them.
- `make lint`: Format YAML with yamlfmt and lint with yamllint.
- `make argo-sync ARGOCD_SELECTOR=key=value`: Force Argo CD Application refresh (limit scope with a selector when needed).

## Coding Style & Naming Conventions
- YAML: 2-space indent; order fields logically (metadata → spec/values); filenames track chart/app names. Try to match the format on our .yamlfmt and .yamllint configs.
- Helm/Argo: Keep Application names aligned with folder scope (e.g., `edge-services-hajimari`).
- Python (`bootstrap/scripts/bootstrap.py`): Maintain type hints, f-strings, and existing logging style. Run `python3 -m compileall bootstrap/scripts` if you modify it.
- Formatting tools: yamlfmt, yamllint. Run `make lint` before committing.
- New apps: add Hajimari discovery labels on the external `HTTPRoute` (`hajimari.edgard.org/enabled: "true"`, `hajimari.edgard.org/icon: <mdi icon without "mdi:">`) and enable Gatus by labeling the Service (`gatus.edgard.org/enabled: "true"`).

## Testing Guidelines
- Core check is manifest formatting/lint (`make lint`).
- For cluster changes, validate locally: `make kind-create`, then `kubectl get pods -A` and `kubectl diff -f <file>` before pushing.
- When updating Argo Applications, confirm chart `targetRevision` matches the intended release to avoid drift.

## Security & Configuration Tips
- Do not commit decrypted secrets. Keep `bootstrap/config/cluster-secrets.sops.yaml` encrypted; `.sops.agekey` stays local and untracked.
- Bootstrap honors env overrides (`MULTUS_PARENT_IFACE`, `MULTUS_PARENT_SUBNET`, `MULTUS_PARENT_GATEWAY`, `MULTUS_PARENT_IP_RANGE`). Document any overrides in your PR.

## Commit & Pull Request Guidelines
- Use Conventional Commits as seen in history (`refactor(argo): ...`, `chore(deps): ...`, `fix(multus): ...`).
- Keep PRs focused; include what changed, validation steps (lint, Kind/Argo checks), and any manual rollout actions (`make argo-sync`, reapplying secrets).
