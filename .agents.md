# AI Maintainer Guide

- Keep this file current. Any change to automation, commands, dependencies, layout, or docs must update `.agents.md` (and README.md) in the same commit/PR.
- Default to safe edits: never drop user changes, never commit decrypted secrets, avoid destructive git operations unless explicitly asked.
- Prefer `rg`/`rg --files` for search; stay ASCII unless a file already uses other characters.
- README is intentionally high level; keep detailed procedures and dependency notes here.

## Repo Layout
- `bootstrap/config/` – Kind cluster config and SOPS secret template (`cluster-config.yaml`, `cluster-secrets.template.yaml`, encrypted `cluster-secrets.sops.yaml`). Age key lives locally at `.sops.agekey`.
- `bootstrap/scripts/bootstrap.py` – Kind/Multus/Argo installer; expects Docker context `kind-<cluster>` (default `kind-homelab`) to exist.
- `argocd/` – `root.app.yaml` bootstraps namespaces, projects, and the ApplicationSet (`appsets/apps.appset.yaml` with RollingSync tiers).
- `apps/<group>/<app>/` – `config.yaml` (chart source/version + optional rollout/sync), `values.yaml`, optional `manifests/` (always synced). Groups: argocd, kube-system, platform-system, ops, edge-services, media, home-automation.
- `terraform/` – OpenTofu configs for Cloudflare using Backblaze B2 S3 backend (`shadowhausterraform/homelab/terraform.tfstate`); module in `terraform/cloudflare/`.

## Bootstrap Flow
- Dependencies: docker, kind, kubectl, helm, python3 + PyYAML, sops + age-keygen, prettier, yamlfmt, yamllint, tofu.
- Create docker context `kind-homelab` (or `kind-<name>` from `cluster-config.yaml`) pointing at the host running dockerd; bootstrap fails if the context is missing.
- `make secrets-create-key` → writes `.sops.agekey`; `make secrets-edit` → populates/edits `cluster-secrets.sops.yaml` from the template.
- `make bootstrap` creates Kind, attaches workers to a macvlan network, patches kubeconfig endpoint (if remote), installs Multus and Argo CD via Helm using versions from app configs, applies cluster secrets, seeds the Argo repo secret, then applies the root Argo CD app.
- Delete/recreate: `make bootstrap-delete` / `make bootstrap-recreate`. Local-only: `make kind-create|kind-delete|kind-recreate`, `make kind-status`.
- Env overrides honored by bootstrap: `MULTUS_PARENT_IFACE`, `MULTUS_PARENT_SUBNET`, `MULTUS_PARENT_GATEWAY`, `MULTUS_PARENT_IP_RANGE` (document when used).

## Argo CD & Apps
- ApplicationSet uses go-template + RollingSync tiers (lower = earlier):
- 1 base system: argocd/argocd; kube-system/k8tz, kube-system/metrics-server, kube-system/coredns (Corefile override); platform-system/multus
  - 2 controllers/operators: platform-system/reloader, platform-system/external-secrets, platform-system/metacontroller
  - 3 PKI/security control-plane: platform-system/cert-manager, platform-system/homelab-controller, platform-system/falco
  - 4 ingress gateway: platform-system/envoy-gateway
  - 5 edge DNS/auth: platform-system/cloudflared, platform-system/external-dns-{internal,external}, platform-system/dex
  - 10 default catch-all
- Destination namespace defaults to the group directory unless overridden in `config.yaml`.
- `rollout.tier` sets ordering; `sync.serverSideApply: true` for CRDs/operators.
- Metacontroller renders Hajimari, Gatus, Dex configs; edit templates under `manifests/metacontroller/`, never the generated `*-config-generated` ConfigMaps. Keep the three implementations structurally aligned (only app-specific diffs).
- New HTTPRoutes should carry Hajimari labels `hajimari.edgard.org/enabled: "true"` and `hajimari.edgard.org/icon: <mdi icon without "mdi:">`; enable Gatus by labeling Services `gatus.edgard.org/enabled: "true"`.
- Envoy Gateway enforces a global Coraza WAF via `EnvoyExtensionPolicy` on both internal/external gateways using `ghcr.io/corazawaf/coraza-proxy-wasm:0.6.0` with `failOpen: false`.
- CoreDNS override lives at `apps/kube-system/coredns/values.yaml`; it forwards `edgard.org` to Unifi (192.168.1.1). Ensure Unifi serves internal records (e.g., `id.edgard.org`) as expected.

## Commands
- Lint/format YAML: `make lint` (prettier ➜ yamlfmt ➜ yamllint).
- Secrets: `make secrets-create-key`, `make secrets-edit`, `make secrets-apply` (decrypts and applies to current kube context).
- Argo resync without CLI: `make argo-sync ARGOCD_SELECTOR=key=value`.
- Renovate: `.renovaterc.json5` has a regex manager that tracks any `url:` WASM image in EnvoyExtensionPolicy manifests under `apps/*/*/manifests/*.envoyextensionpolicy.yaml` (docker datasource).
- Terraform: `make tf-plan|tf-apply|tf-validate|tf-clean` (default dir `terraform/cloudflare`). Env required: `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY` (B2 backend), `CLOUDFLARE_API_TOKEN`, `TF_VAR_cloudflare_zone_id`. `.envrc` provides local values—do not commit rotations here.

## Coding Style & Patterns
- YAML: 2-space indent; logical ordering (metadata → spec/values); filenames track chart/app names; keep `manifests/` dirs present even if empty.
- Python (`bootstrap/scripts/bootstrap.py`): type hints, f-strings, existing logging style; run `python3 -m compileall bootstrap/scripts` after edits if you change it.
- Conventional Commits (`feat:`, `fix:`, `refactor:`, `chore(deps):`, etc.). Keep PRs focused; note validation steps (lint, Kind/Argo checks) and any manual rollout actions.
- Follow existing organization/naming: app folder name = Argo Application name; destination namespace defaults to the group folder; filenames mirror chart/app; metacontroller implementations stay visually identical across apps except for intentional spec/label/selectors; RollingSync tiers reflect current scheme (1 core k8s → 10 default). If you must diverge, document the rationale and update `.agents.md` + README in the same change.

## Testing & Safety
- Baseline: `make lint`.
- Targeted manifest tweaks (rare): use `kubectl diff -f <path>` for dry-run inspection only. Do not `kubectl apply`/`kubectl patch` Argo-managed resources—Argo sync will overwrite; make changes in Git and let Argo reconcile.
- When updating Argo Applications, confirm chart `targetRevision` matches the intended release to avoid drift.
- Never commit decrypted secrets; `.sops.agekey` stays untracked/local.
