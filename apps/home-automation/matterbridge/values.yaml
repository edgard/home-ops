---
defaultPodOptions:
  securityContext:
    fsGroup: 0
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 0
    runAsUser: 0
    runAsNonRoot: false

controllers:
  main:
    type: deployment
    replicas: 1
    strategy: Recreate
    pod:
      annotations:
        k8s.v1.cni.cncf.io/networks: |-
          [
            {
              "name": "multus-lan-macvlan",
              "namespace": "kube-system",
              "ips": ["192.168.1.243/24"],
              "gateway": ["192.168.1.1"],
              "mac": "02:42:c0:a8:01:f3"
            }
          ]
    initContainers:
      copy-config:
        image:
          repository: busybox
          tag: 1.37.0
        command:
          - /bin/sh
          - -c
          - |
            cp /config-templates/*.config.json /root/.matterbridge/
            sed -i "s|\${HASS_TOKEN}|$HASS_TOKEN|g" /root/.matterbridge/matterbridge-hass.config.json
        envFrom:
          - secretRef:
              name: matterbridge-credentials
      register-plugins:
        image:
          repository: luligu/matterbridge
          tag: 3.4.7
        command:
          - /bin/sh
          - -c
          - |
            matterbridge --add matterbridge-hass
            matterbridge --enable matterbridge-hass
            matterbridge --list
    containers:
      app:
        image:
          repository: luligu/matterbridge
          tag: 3.4.7
        command:
          - matterbridge
        args:
          - "--mdnsinterface"
          - "net1"
        env:
          MATTERBRIDGE_DEBUG: "false"
          MATTERBRIDGE_LOGGING: info
        envFrom:
          - secretRef:
              name: matterbridge-credentials
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

configMaps:
  config:
    enabled: true
    data:
      matterbridge.config.json: |
        {
          "name": "Matterbridge",
          "type": "bridge",
          "frontend": 8283,
          "debug": false,
          "unregisterOnShutdown": false
        }
      matterbridge-hass.config.json: |
        {
          "name": "matterbridge-hass",
          "type": "DynamicPlatform",
          "enabled": true,
          "host": "ws://home-assistant.home-automation.svc.cluster.local:8123",
          "token": "${HASS_TOKEN}",
          "certificatePath": "",
          "rejectUnauthorized": true,
          "reconnectTimeout": 60,
          "reconnectRetries": 20,
          "filterByArea": "",
          "filterByLabel": "",
          "applyFiltersToDeviceEntities": false,
          "whiteList": [
            "Bathroom Sink Water Sensor",
            "Bathroom Washer Water Sensor",
            "Bathroom Washer Vibration Sensor",
            "Bedroom Ceiling Lights",
            "Bedroom Climate Sensor",
            "Bedroom Heater",
            "Bedroom Left Shades",
            "Bedroom Mood Light",
            "Bedroom Right Shades",
            "Bedroom Window Sensor",
            "Bike Trainer",
            "Guest Bathroom Sink Water Sensor",
            "Living Room Climate Sensor",
            "Living Room Corridor Lights",
            "Living Room Door Sensor",
            "Living Room Mood Light",
            "Living Room Motion Sensor",
            "Living Room Sink Water Sensor",
            "Living Room Window Sensor",
            "Living Room Washer Vibration Sensor",
            "Office 3D Printer",
            "Office Ceiling Lights",
            "Office Climate Sensor",
            "Office Heater",
            "Office Motion Sensor",
            "Office Shelf Lights",
            "Office Window Sensor",
            "Rouvida Bike Charger",
            "Zebra Bike Charger",
            "fan.bedroom_air_purifier_clean",
            "fan.office_air_purifier_clean",
            "input_boolean.home_presence",
            "light.office_key_lights",
            "sensor.bedroom_air_quality",
            "sensor.office_air_quality"
          ],
          "blackList": [],
          "deviceEntityBlackList": {
            "Bedroom Heater": ["switch.bedroom_heater_child_lock", "switch.bedroom_heater_display_flip", "switch.bedroom_heater_helper", "switch.bedroom_heater_state", "switch.bedroom_heater_temperature_setpoint_hold", "switch.bedroom_heater_valve_detection", "switch.bedroom_heater_window_detection"],
            "Office Heater": ["switch.office_heater_child_lock", "switch.office_heater_display_flip", "switch.office_heater_helper", "switch.office_heater_state", "switch.office_heater_temperature_setpoint_hold", "switch.office_heater_valve_detection", "switch.office_heater_window_detection"],
            "Bedroom Left Shades": ["sensor.bedroom_left_shades_device_temperature", "switch.bedroom_left_shades_reverse_direction"],
            "Bedroom Right Shades": ["sensor.bedroom_right_shades_device_temperature", "switch.bedroom_right_shades_reverse_direction"],
            "Bike Trainer": ["switch.bike_trainer_child_lock", "switch.bike_trainer_led_enable"],
            "Office 3D Printer": ["switch.office_3d_printer_child_lock", "switch.office_3d_printer_led_enable"],
            "Rouvida Bike Charger": ["switch.rouvida_bike_charger_child_lock", "switch.rouvida_bike_charger_led_enable"],
            "Zebra Bike Charger": ["switch.zebra_bike_charger_child_lock", "switch.zebra_bike_charger_led_enable"],
            "Office Motion Sensor": ["switch.office_motion_sensor_find_switch"],
            "Bathroom Sink Water Sensor": ["sensor.bathroom_sink_water_sensor_device_temperature"],
            "Bathroom Washer Water Sensor": ["sensor.bathroom_washer_water_sensor_device_temperature"],
            "Bathroom Washer Vibration Sensor": ["sensor.bathroom_washer_vibration_sensor_device_temperature"],
            "Guest Bathroom Sink Water Sensor": ["sensor.guest_bathroom_sink_water_sensor_device_temperature"],
            "Living Room Sink Water Sensor": ["sensor.living_room_sink_water_sensor_device_temperature"],
            "Living Room Washer Vibration Sensor": ["sensor.living_room_washer_vibration_sensor_device_temperature"],
            "Bedroom Window Sensor": ["sensor.bedroom_window_sensor_device_temperature"],
            "Living Room Door Sensor": ["sensor.living_room_door_sensor_device_temperature"],
            "Living Room Window Sensor": ["sensor.living_room_window_sensor_device_temperature"],
            "Office Window Sensor": ["sensor.office_window_sensor_device_temperature"]
          },
          "splitEntities": [],
          "airQualityRegex": "^sensor\\..*_air_quality$",
          "enableServerRvc": true,
          "debug": false,
          "unregisterOnShutdown": false
        }
persistence:
  data:
    type: persistentVolumeClaim
    enabled: true
    accessMode: ReadWriteOnce
    size: 5Gi
    globalMounts:
      - path: /root/.matterbridge
  config-templates:
    type: configMap
    name: matterbridge
    advancedMounts:
      main:
        copy-config:
          - path: /config-templates
            readOnly: true

service:
  main:
    controller: main
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 8283

route:
  main:
    annotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: Matterbridge
      gethomepage.dev/group: Home Automation
      gethomepage.dev/icon: matter.svg
      gethomepage.dev/app: matterbridge
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - matterbridge.edgard.org
    rules:
      - backendRefs:
          - identifier: main
            port: 8283
