---
defaultPodOptions:
  securityContext:
    fsGroup: 0
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 0
    runAsUser: 0
    runAsNonRoot: false

controllers:
  main:
    type: deployment
    replicas: 1
    strategy: Recreate
    pod:
      annotations:
        k8s.v1.cni.cncf.io/networks: |-
          [
            {
              "name": "multus-lan-macvlan",
              "namespace": "platform-system",
              "ips": ["192.168.1.243/24"],
              "mac": "02:42:c0:a8:01:f3",
              "gateway": ["192.168.1.1"]
            }
          ]
    initContainers:
      copy-config:
        image:
          repository: busybox
          tag: 1.37.0
        command:
          - /bin/sh
          - -c
          - |
            cp /config-templates/*.config.json /root/.matterbridge/
            sed -i "s|\${HASS_TOKEN}|$HASS_TOKEN|g" /root/.matterbridge/matterbridge-hass.config.json
        envFrom:
          - secretRef:
              name: matterbridge-credentials
      register-plugins:
        image:
          repository: luligu/matterbridge
          tag: 3.4.4
        command:
          - /bin/sh
          - -c
          - |
            matterbridge --add matterbridge-zigbee2mqtt
            #matterbridge --add matterbridge-shelly
            matterbridge --add matterbridge-hass
            matterbridge --enable matterbridge-zigbee2mqtt
            #matterbridge --disable matterbridge-shelly
            matterbridge --enable matterbridge-hass
            matterbridge --list
    containers:
      app:
        image:
          repository: luligu/matterbridge
          tag: 3.4.4
        command:
          - matterbridge
        args:
          - "--mdnsinterface"
          - "net1"
        env:
          MATTERBRIDGE_DEBUG: "false"
          MATTERBRIDGE_LOGGING: info
        envFrom:
          - secretRef:
              name: matterbridge-credentials
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

configMaps:
  config:
    enabled: true
    data:
      matterbridge.config.json: |
        {
          "name": "Matterbridge",
          "type": "bridge",
          "frontend": 8283,
          "debug": false,
          "unregisterOnShutdown": false,
        }
      matterbridge-zigbee2mqtt.config.json: |
        {
          "name": "matterbridge-zigbee2mqtt",
          "type": "DynamicPlatform",
          "enabled": true,
          "host": "mqtt://mosquitto.home-automation.svc.cluster.local",
          "port": 1883,
          "protocolVersion": 5,
          "topic": "zigbee2mqtt",
          "username": "",
          "password": "",
          "whiteList": [],
          "blackList": [
            "Coordinator",
            "Living Room Zigbee Repeater",
            "Living Room IR Blaster",
            "Office Switch",
            "Bedroom TV Switch",
            "Bedroom Bed Switch"
          ],
          "switchList": [],
          "lightList": [],
          "outletList": [
            "Rouvida Bike Charger",
            "Office 3D Printer",
            "Zebra Bike Charger",
            "Bike Trainer"
          ],
          "featureBlackList": [
            "linkquality",
            "update",
            "update_available",
            "pressure",
            "device_temperature"
          ],
          "deviceFeatureBlackList": {
            "Office Motion Sensor": ["illuminance"],
            "Living Room Motion Sensor": ["illuminance"]
          },
          "scenesType": "outlet",
          "scenesPrefix": true,
          "debug": false,
          "unregisterOnShutdown": false
        }
      matterbridge-shelly.config.json: |
        {
          "name": "matterbridge-shelly",
          "type": "DynamicPlatform",
          "enabled": true,
          "username": "",
          "password": "",
          "switchList": [],
          "lightList": [],
          "inputContactList": [],
          "inputMomentaryList": [],
          "inputLatchingList": [],
          "whiteList": [],
          "blackList": [],
          "entityBlackList": [],
          "deviceEntityBlackList": {},
          "nocacheList": [],
          "deviceIp": {},
          "enableMdnsDiscover": true,
          "enableStorageDiscover": true,
          "resetStorageDiscover": false,
          "enableConfigDiscover": false,
          "enableBleDiscover": false,
          "interfaceAddress": "192.168.1.243",
          "failsafeCount": 0,
          "debug": false,
          "debugMdns": false,
          "debugCoap": false,
          "debugWs": false,
          "unregisterOnShutdown": false
        }
      matterbridge-hass.config.json: |
        {
          "name": "matterbridge-hass",
          "type": "DynamicPlatform",
          "enabled": true,
          "host": "ws://home-assistant.home-automation.svc.cluster.local:8123",
          "token": "${HASS_TOKEN}",
          "certificatePath": "",
          "rejectUnauthorized": true,
          "reconnectTimeout": 60,
          "reconnectRetries": 10,
          "filterByArea": "",
          "filterByLabel": "",
          "applyFiltersToDeviceEntities": false,
          "whiteList": [
            "50e08b118e409ab93e15de16599b8b94",
            "e9a95dcce66ccd9b39797d23fe77bd5d",
            "7170f00ac38ea0f8f5d8f09ef2312b84",
            "b3538dfeb50e037b3411e777cbfd34d6",
            "c6c22103aade48985d6bcccf38419bf5",
            "497390d2653ba551a1cd02a780cc1f93",
            "7043ea9dbe8e6c992b06c8a4246847cc",
            "aa8588cf022f52ffabca618900054127",
            "fan.bedroom_air_purifier_matter",
            "fan.office_air_purifier_matter"
          ],
          "blackList": [],
          "splitEntities": [],
          "enableServerRvc": true,
          "debug": false,
          "unregisterOnShutdown": false
        }

persistence:
  data:
    type: persistentVolumeClaim
    enabled: true
    storageClass: local-fast
    accessMode: ReadWriteOnce
    size: 5Gi
    globalMounts:
      - path: /root/.matterbridge
  config-templates:
    type: configMap
    name: matterbridge
    advancedMounts:
      main:
        copy-config:
          - path: /config-templates
            readOnly: true

service:
  main:
    controller: main
    ports:
      http:
        port: 8283

route:
  main:
    annotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: Matterbridge
      gethomepage.dev/group: Home Automation
      gethomepage.dev/icon: matter.svg
      gethomepage.dev/app: matterbridge
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - matterbridge.edgard.org
    rules:
      - backendRefs:
          - identifier: main
            port: 8283
