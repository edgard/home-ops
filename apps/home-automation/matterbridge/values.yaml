---
defaultPodOptions:
  securityContext:
    fsGroup: 0
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 0
    runAsUser: 0
    runAsNonRoot: false

controllers:
  main:
    type: deployment
    replicas: 1
    strategy: Recreate
    pod:
      annotations:
        k8s.v1.cni.cncf.io/networks: |-
          [
            {
              "name": "multus-lan-bridge",
              "namespace": "kube-system",
              "ips": ["192.168.1.243/24"],
              "gateway": ["192.168.1.1"],
              "mac": "02:42:c0:a8:01:f3"
            }
          ]
    initContainers:
      copy-config:
        image:
          repository: busybox
          tag: 1.37.0
        command:
          - /bin/sh
          - -c
          - |
            cp /config-templates/matterbridge.config.json /root/.matterbridge/
            cp /config-templates/matterbridge-zigbee2mqtt.config.json /root/.matterbridge/
            sed "s|\${HASS_TOKEN}|${HASS_TOKEN}|g" /config-templates/matterbridge-hass.config.json > /root/.matterbridge/matterbridge-hass.config.json
        env:
          HASS_TOKEN:
            secretKeyRef:
              name: matterbridge-credentials
              key: HASS_TOKEN
      register-plugins:
        image:
          repository: luligu/matterbridge
          tag: 3.5.2
        command:
          - /bin/sh
          - -c
          - |
            matterbridge --add matterbridge-zigbee2mqtt
            matterbridge --enable matterbridge-zigbee2mqtt
            matterbridge --add matterbridge-hass
            matterbridge --enable matterbridge-hass
            matterbridge --list
    containers:
      app:
        image:
          repository: luligu/matterbridge
          tag: 3.5.2
        command:
          - matterbridge
        args:
          - "--mdnsinterface"
          - "net1"
        env:
          MATTERBRIDGE_DEBUG: "false"
          MATTERBRIDGE_LOGGING: info
          HASS_TOKEN:
            secretKeyRef:
              name: matterbridge-credentials
              key: HASS_TOKEN
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

configMaps:
  config:
    enabled: true
    data:
      matterbridge.config.json: |
        {
          "name": "Matterbridge",
          "type": "bridge",
          "frontend": 8283,
          "debug": false,
          "unregisterOnShutdown": false
        }
      matterbridge-zigbee2mqtt.config.json: |
        {
          "name": "matterbridge-zigbee2mqtt",
          "type": "DynamicPlatform",
          "enabled": true,
          "host": "mqtt://mosquitto.home-automation.svc.cluster.local",
          "port": 1883,
          "protocolVersion": 5,
          "topic": "zigbee2mqtt",
          "username": "",
          "password": "",
          "whiteList": [],
          "blackList": [
            "Coordinator",
            "Living Room Zigbee Repeater"
          ],
          "switchList": [],
          "lightList": [],
          "outletList": [
            "Rouvida Bike Charger",
            "Office 3D Printer",
            "Zebra Bike Charger",
            "Bike Trainer"
          ],
          "featureBlackList": [
            "linkquality",
            "last_seen",
            "elapsed",
            "update",
            "update_available",
            "device_temperature"
          ],
          "deviceFeatureBlackList": {
            "Office Motion Sensor": ["illuminance"]
          },
          "scenesType": "outlet",
          "scenesPrefix": true,
          "debug": false,
          "unregisterOnShutdown": false
        }
      matterbridge-hass.config.json: |
        {
          "name": "matterbridge-hass",
          "type": "DynamicPlatform",
          "enabled": true,
          "host": "ws://homeassistant.home-automation.svc.cluster.local:8123",
          "token": "${HASS_TOKEN}",
          "whiteList": [
            "Office Key Light Left ",
            "Office Key Light Right",
            "Bedroom Air Purifier Fan",
            "Office Air Purifier Fan",
            "fan.dmaker_1c_32fd_fan",
            "fan.dmaker_1c_3cfa_fan"
          ],
          "blackList": [],
          "splitEntities": [
            "fan.dmaker_1c_32fd_fan",
            "fan.dmaker_1c_3cfa_fan"
          ],
          "debug": false,
          "unregisterOnShutdown": false
        }

persistence:
  data:
    type: persistentVolumeClaim
    enabled: true
    accessMode: ReadWriteOnce
    size: 5Gi
    globalMounts:
      - path: /root/.matterbridge
  config-templates:
    type: configMap
    name: matterbridge
    advancedMounts:
      main:
        copy-config:
          - path: /config-templates
            readOnly: true

service:
  main:
    controller: main
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 8283

route:
  main:
    annotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: Matterbridge
      gethomepage.dev/group: Home Automation
      gethomepage.dev/icon: matter.svg
      gethomepage.dev/app: matterbridge
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - matterbridge.edgard.org
    rules:
      - backendRefs:
          - identifier: main
            port: 8283
