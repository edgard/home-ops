---
defaultPodOptions:
  securityContext:
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 1000
    runAsNonRoot: true
    runAsUser: 1000

controllers:
  main:
    annotations:
      reloader.stakater.com/auto: "true"
    type: deployment
    replicas: 1
    strategy: Recreate
    serviceAccount:
      identifier: homepage
    initContainers:
      init-config:
        image:
          repository: ghcr.io/gethomepage/homepage
          tag: v1.9.0
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        command:
          - sh
          - -c
          - |
            cp /tmp/config-ro/* /app/config/
    containers:
      app:
        image:
          repository: ghcr.io/gethomepage/homepage
          tag: v1.9.0
        env:
          LOG_TARGETS: stdout
          HOMEPAGE_DISABLE_HOST_VALIDATION: "true"
          HOMEPAGE_ALLOWED_HOSTS: "*"
        ports:
          - name: http
            containerPort: 3000
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

serviceAccount:
  homepage:
    enabled: true

rbac:
  roles:
    homepage:
      type: ClusterRole
      rules:
        - apiGroups:
            - ""
          resources:
            - namespaces
            - nodes
            - pods
            - services
            - serviceaccounts
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - networking.k8s.io
          resources:
            - ingresses
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - gateway.networking.k8s.io
          resources:
            - gateways
            - httproutes
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - security.istio.io
          resources:
            - authorizationpolicies
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - traefik.io
          resources:
            - ingressroutes
          verbs:
            - get
            - list
            - watch
  bindings:
    homepage:
      type: ClusterRoleBinding
      roleRef:
        identifier: homepage
      subjects:
        - identifier: homepage
          kind: ServiceAccount

service:
  main:
    controller: main
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 3000

route:
  main:
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - dash.edgard.org
    rules:
      - backendRefs:
          - identifier: main
            port: 3000

persistence:
  config:
    type: emptyDir
    globalMounts:
      - path: /app/config
  config-ro:
    type: configMap
    identifier: config
    advancedMounts:
      main:
        init-config:
          - path: /tmp/config-ro
            readOnly: true

configMaps:
  config:
    data:
      settings.yaml: |-
        title: Homelab
        startUrl: https://dash.edgard.org
        theme: dark
        color: slate
        disableUpdateCheck: true
        hideVersion: true
        target: _self
        statusStyle: dot
      kubernetes.yaml: |-
        mode: cluster
        gateway: true
        ingress: false
      widgets.yaml: |-
        - greeting:
            text_size: 4xl
            text: Homelab
      services.yaml: |-
        - Platform:
          - Unifi:
              icon: unifi.svg
              href: https://unifi.ui.com
              siteMonitor: https://unifi.home.arpa
      bookmarks.yaml: |-
        []
