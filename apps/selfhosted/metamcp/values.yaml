---
defaultPodOptions:
  securityContext:
    fsGroup: 1001
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 1001
    runAsNonRoot: true
    runAsUser: 1001

controllers:
  metamcp:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: ghcr.io/metatool-ai/metamcp
          tag: 2.4.22
        env:
          NODE_ENV: production
          APP_URL: https://metamcp.edgard.org
          NEXT_PUBLIC_APP_URL: https://metamcp.edgard.org
          POSTGRES_HOST: localhost
          POSTGRES_PORT: "5432"
          POSTGRES_USER: metamcp
          POSTGRES_DB: metamcp
          POSTGRES_PASSWORD: metamcp
          DATABASE_URL: postgresql://metamcp:metamcp@localhost:5432/metamcp
          BETTER_AUTH_SECRET:
            valueFrom:
              secretKeyRef:
                name: metamcp-credentials
                key: BETTER_AUTH_SECRET
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        resources: {}
      postgres:
        image:
          repository: postgres
          tag: 16-alpine
        env:
          POSTGRES_USER: metamcp
          POSTGRES_DB: metamcp
          POSTGRES_PASSWORD: metamcp
          PGDATA: /var/lib/postgresql/data/pgdata
        probes:
          startup:
            enabled: true
            spec:
              exec:
                command:
                  - pg_isready
                  - -U
                  - metamcp
          liveness:
            enabled: true
            spec:
              exec:
                command:
                  - pg_isready
                  - -U
                  - metamcp
          readiness:
            enabled: true
            spec:
              exec:
                command:
                  - pg_isready
                  - -U
                  - metamcp
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          runAsUser: 999
          runAsGroup: 999
        resources: {}

service:
  metamcp:
    controller: metamcp
    primary: true
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 12008

route:
  main:
    annotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: MetaMCP
      gethomepage.dev/group: Selfhosted
      gethomepage.dev/icon: mdi-api
      gethomepage.dev/app: metamcp
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - metamcp.edgard.org
    rules:
      - backendRefs:
          - identifier: metamcp
            port: 12008

persistence:
  postgres-data:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 1Gi
    advancedMounts:
      metamcp:
        postgres:
          - path: /var/lib/postgresql/data
