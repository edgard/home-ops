---
defaultPodOptions:
  securityContext:
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 1000
    runAsNonRoot: true
    runAsUser: 1000

controllers:
  karakeep:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: ghcr.io/karakeep-app/karakeep
          tag: 0.29.3
        env:
          DATA_DIR: /data
          NEXTAUTH_URL: https://karakeep.edgard.org
          MEILI_ADDR: http://karakeep-meilisearch.selfhosted.svc.cluster.local:7700
          BROWSER_WEB_URL: http://karakeep-chrome.selfhosted.svc.cluster.local:9222
          CRAWLER_DOWNLOAD_BANNER_IMAGE: "true"
          CRAWLER_ENABLE_ADBLOCKER: "true"
          CRAWLER_STORE_SCREENSHOT: "true"
          DISABLE_NEW_RELEASE_CHECK: "true"
          DISABLE_SIGNUPS: true
          DB_WAL_MODE: "true"
          OPENAI_BASE_URL: https://openrouter.ai/api/v1
          OPENAI_API_KEY:
            valueFrom:
              secretKeyRef:
                name: karakeep-credentials
                key: OPENAI_API_KEY
          INFERENCE_CONTEXT_LENGTH: "4096"
          INFERENCE_TEXT_MODEL: openai/gpt-5-mini
          INFERENCE_IMAGE_MODEL: openai/gpt-5-mini
          EMBEDDING_TEXT_MODEL: openai/text-embedding-3-small
          OCR_LANGS: eng,por,pol
          OCR_CACHE_DIR: /data/ocr
          MEILI_MASTER_KEY:
            valueFrom:
              secretKeyRef:
                name: karakeep-credentials
                key: MEILI_MASTER_KEY
          NEXTAUTH_SECRET:
            valueFrom:
              secretKeyRef:
                name: karakeep-credentials
                key: NEXTAUTH_SECRET
          COREPACK_INTEGRITY_KEYS: 0
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true
        resources:
          limits: null
          requests: null

  chrome:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    pod:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
    containers:
      app:
        image:
          repository: gcr.io/zenika-hub/alpine-chrome
          tag: "124"
        command:
          - chromium-browser
        args:
          - --headless
          - --no-sandbox
          - --disable-gpu
          - --disable-software-rasterizer
          - --disable-dev-shm-usage
          - --remote-debugging-address=0.0.0.0
          - --remote-debugging-port=9222
          - --hide-scrollbars
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

  meilisearch:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    pod:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
    containers:
      app:
        image:
          repository: getmeili/meilisearch
          tag: v1.31.0
        args:
          - /bin/meilisearch
          - --experimental-dumpless-upgrade
        env:
          MEILI_NO_ANALYTICS: "true"
          MEILI_MASTER_KEY:
            valueFrom:
              secretKeyRef:
                name: karakeep-credentials
                key: MEILI_MASTER_KEY
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

service:
  karakeep:
    controller: karakeep
    primary: true
    forceRename: karakeep
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 3000
  chrome:
    controller: chrome
    ports:
      http:
        port: 9222
  meilisearch:
    controller: meilisearch
    ports:
      http:
        port: 7700

route:
  main:
    annotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: Karakeep
      gethomepage.dev/group: Selfhosted
      gethomepage.dev/icon: karakeep.svg
      gethomepage.dev/app: karakeep
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - karakeep.edgard.org
    rules:
      - backendRefs:
          - identifier: karakeep
            port: 3000

persistence:
  data:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 5Gi
    advancedMounts:
      karakeep:
        app:
          - path: /data
            subPath: data
      meilisearch:
        app:
          - path: /meili_data
            subPath: meilisearch
