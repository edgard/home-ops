---
defaultPodOptions:
  securityContext:
    fsGroup: 0
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 0
    runAsNonRoot: false
    runAsUser: 0

controllers:
  paperless:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    initContainers:
      tesseract-langs:
        image:
          repository: ghcr.io/paperless-ngx/paperless-ngx
          tag: 2.20.5
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
        env:
          PAPERLESS_OCR_LANGUAGES: eng por pol
        command:
          - /bin/bash
          - -c
        args:
          - |
            set -e

            echo "Installing tesseract language packages..."

            # Update package lists
            apt-get update

            # Install languages from PAPERLESS_OCR_LANGUAGES
            # Convert space-separated list to apt package names (tesseract-ocr-<lang>)
            PACKAGES="tesseract-ocr"
            for lang in $PAPERLESS_OCR_LANGUAGES; do
              PACKAGES="$PACKAGES tesseract-ocr-$lang"
              echo "  - Adding tesseract-ocr-$lang"
            done

            # Install all packages (this includes osd.traineddata automatically)
            apt-get install -y --no-install-recommends $PACKAGES

            # Copy installed tessdata to shared volume
            TESSDIR=/shared-tessdata
            mkdir -p "$TESSDIR"
            cp -r /usr/share/tesseract-ocr/5/tessdata/* "$TESSDIR/"

            # Set proper permissions for the app user (1000:1000)
            chown -R 1000:1000 "$TESSDIR"

            # List installed languages for debugging
            echo "Installed tesseract data files:"
            ls -lh "$TESSDIR"

            # Clean up apt cache to reduce image size impact
            apt-get clean
            rm -rf /var/lib/apt/lists/*

            echo "Tesseract language packages installed successfully"
    containers:
      app:
        image:
          repository: ghcr.io/paperless-ngx/paperless-ngx
          tag: 2.20.5
        env:
          PAPERLESS_URL: https://paperless.edgard.org
          PAPERLESS_PORT: "8000"
          PAPERLESS_TIME_ZONE: Europe/Warsaw
          PAPERLESS_WEBSERVER_WORKERS: "2"
          PAPERLESS_TASK_WORKERS: "2"
          PAPERLESS_BIND_ADDR: 0.0.0.0
          PAPERLESS_OCR_LANGUAGE: eng+por+pol
          PAPERLESS_ALLOWED_HOSTS: paperless.edgard.org,paperless.selfhosted.svc.cluster.local,paperless,localhost,127.0.0.1
          PAPERLESS_CSRF_TRUSTED_ORIGINS: https://paperless.edgard.org
          PAPERLESS_PROXY_SSL_HEADER: '["HTTP_X_FORWARDED_PROTO", "https"]'
          PAPERLESS_REDIS: redis://paperless-redis:6379
          PAPERLESS_TIKA_ENABLED: "1"
          PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
          PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000
          PAPERLESS_CONSUMER_POLLING: "60"
          PAPERLESS_CONSUMER_RECURSIVE: "true"
          PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS: "true"
          PAPERLESS_CONSUMPTION_DIR: /usr/src/paperless/inbox
          USERMAP_UID: "1000"
          USERMAP_GID: "1000"
          PAPERLESS_SECRET_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-credentials
                key: PAPERLESS_SECRET_KEY
          PAPERLESS_ADMIN_USER:
            valueFrom:
              secretKeyRef:
                name: paperless-credentials
                key: PAPERLESS_ADMIN_USER
          PAPERLESS_ADMIN_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: paperless-credentials
                key: PAPERLESS_ADMIN_PASSWORD
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
            add:
              - CHOWN
              - SETUID
              - SETGID
        resources:
          limits: null
          requests: null

  gpt:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: icereed/paperless-gpt
          tag: v0.24.0
        env:
          PAPERLESS_BASE_URL: http://paperless.selfhosted.svc.cluster.local:8000
          PAPERLESS_PUBLIC_URL: https://paperless.edgard.org
          LLM_PROVIDER: openai
          LLM_MODEL: openai/gpt-5-mini
          VISION_LLM_PROVIDER: openai
          VISION_LLM_MODEL: openai/gpt-5-mini
          OPENAI_BASE_URL: https://openrouter.ai/api/v1
          OCR_PROVIDER: "llm"
          PDF_SKIP_EXISTING_OCR: "false"
          PDF_OCR_TAGGING: "false"
          PAPERLESS_API_TOKEN:
            valueFrom:
              secretKeyRef:
                name: paperless-credentials
                key: PAPERLESS_API_TOKEN
          OPENAI_API_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-credentials
                key: OPENAI_API_KEY
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

  gotenberg:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    pod:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
    containers:
      app:
        image:
          repository: docker.io/gotenberg/gotenberg
          tag: "8.26.0"
        args:
          - gotenberg
          - --chromium-disable-javascript=true
          - --chromium-allow-list=file:///tmp/.*
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

  tika:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    pod:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
    containers:
      app:
        image:
          repository: docker.io/apache/tika
          tag: 3.2.3.0
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true
  redis:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    pod:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
    containers:
      app:
        image:
          repository: docker.io/library/redis
          tag: "8.4.0"
        args:
          - redis-server
          - --save
          - ""
        probes:
          startup:
            enabled: true
          liveness:
            enabled: true
          readiness:
            enabled: true

service:
  paperless:
    controller: paperless
    primary: true
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 8000

  gpt:
    controller: gpt
    ports:
      http:
        port: 8080

  gotenberg:
    controller: gotenberg
    ports:
      http:
        port: 3000

  tika:
    controller: tika
    ports:
      http:
        port: 9998

  redis:
    controller: redis
    ports:
      redis:
        port: 6379

route:
  main:
    annotations:
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: Paperless
      gethomepage.dev/group: Selfhosted
      gethomepage.dev/icon: paperless-ngx.svg
      gethomepage.dev/app: paperless
    parentRefs:
      - name: gateway
        namespace: platform-system
        sectionName: https
    hostnames:
      - paperless.edgard.org
    rules:
      - backendRefs:
          - identifier: paperless
            port: 8000

persistence:
  data:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 30Gi
    advancedMounts:
      paperless:
        app:
          - path: /usr/src/paperless/data
            subPath: data
          - path: /usr/src/paperless/media
            subPath: media
          - path: /usr/src/paperless/export
            subPath: export
          - path: /usr/src/paperless/inbox
            subPath: inbox

  tessdata:
    type: emptyDir
    advancedMounts:
      paperless:
        tesseract-langs:
          - path: /shared-tessdata
        app:
          - path: /usr/share/tesseract-ocr/5/tessdata
