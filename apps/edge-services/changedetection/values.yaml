---
controllers:
  main:
    annotations:
      reloader.stakater.com/reload: changedetection-credentials
    type: deployment
    replicas: 1
    strategy: Recreate
    containers:
      main:
        image:
          repository: ghcr.io/dgtlmoon/changedetection.io
          tag: 0.51.4
        env:
          TZ: Europe/Warsaw
          BASE_URL: https://changedetection.edgard.org
          USE_X_SETTINGS: "1"
          HIDE_REFERER: "true"
          FETCH_WORKERS: "10"
          PLAYWRIGHT_DRIVER_URL: ws://127.0.0.1:3000
          DISABLE_VERSION_CHECK: "true"
        envFrom:
          - secretRef:
              name: changedetection-credentials
        ports:
          - name: http
            containerPort: 5000
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: http
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 5
              failureThreshold: 5
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /
                port: http
              initialDelaySeconds: 15
              periodSeconds: 15
              timeoutSeconds: 5
              failureThreshold: 3
        lifecycle:
          postStart:
            exec:
              command:
                - python3
                - -c
                - |
                  import json
                  import os
                  import sys
                  import time

                  import requests

                  HOST = "http://127.0.0.1:5000"
                  key = os.environ.get("CD_IO_API_KEY")
                  url = os.environ.get("CD_IO_NOTIFICATION_URL")

                  if not key or not url:
                      sys.exit("missing API key or notification URL")

                  for attempt in range(30):
                      try:
                          requests.get(f"{HOST}/", timeout=2).raise_for_status()
                          break
                      except Exception:
                          if attempt == 29:
                              sys.exit("changedetection service is unavailable")
                          time.sleep(2)

                  payload = json.dumps({"notification_urls": [url]})
                  resp = requests.put(
                      f"{HOST}/api/v1/notifications",
                      headers={"x-api-key": key, "Content-Type": "application/json"},
                      data=payload,
                      timeout=5,
                  )
                  resp.raise_for_status()
      browser-sockpuppet-chrome:
        image:
          repository: dgtlmoon/sockpuppetbrowser
          tag: "0.0.3"
        env:
          TZ: Europe/Warsaw
          SCREEN_WIDTH: "1920"
          SCREEN_HEIGHT: "1080"
          SCREEN_DEPTH: "16"
          MAX_CONCURRENT_CHROME_PROCESSES: "5"
        ports:
          - name: websocket
            containerPort: 3000
service:
  main:
    controller: main
    type: ClusterIP
    labels:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        enabled: true
        port: 5000
        targetPort: http
ingress:
  main:
    enabled: false
persistence:
  datastore:
    type: hostPath
    hostPath: /mnt/spool/appdata/changedetection
    hostPathType: DirectoryOrCreate
    globalMounts:
      - path: /datastore
