---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: changedetection-notifications
  namespace: edge-services
spec:
  schedule: "0 */6 * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: configure-notifications
              image: curlimages/curl:8.3.0
              command:
                - /bin/sh
                - -c
                - |
                  set -euo pipefail
                  if [ -z "${CD_IO_API_KEY:-}" ] || [ -z "${CD_IO_NOTIFICATION_URL:-}" ]; then
                    echo "CD_IO_API_KEY or CD_IO_NOTIFICATION_URL is not set" >&2
                    exit 1
                  fi
                  host="http://changedetection.edge-services.svc.cluster.local:5000"
                  for attempt in 1 2 3 4 5 6 7 8 9 10 11 12; do
                    if curl -sSf "$host/" >/dev/null; then
                      break
                    fi
                    if [ "$attempt" -eq 12 ]; then
                      echo "changedetection service is unavailable" >&2
                      exit 1
                    fi
                    sleep 5
                  done
                  payload=$(printf '{"notification_urls":["%s"]}' "$CD_IO_NOTIFICATION_URL")
                  curl -sSf -X PUT "$host/api/v1/notifications" \
                    -H "x-api-key: $CD_IO_API_KEY" \
                    -H "Content-Type: application/json" \
                    -d "$payload"
              env:
                - name: CD_IO_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: changedetection-credentials
                      key: CD_IO_API_KEY
                - name: CD_IO_NOTIFICATION_URL
                  valueFrom:
                    secretKeyRef:
                      name: changedetection-credentials
                      key: CD_IO_NOTIFICATION_URL
          serviceAccountName: default
