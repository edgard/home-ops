---
defaultPodOptions:
  securityContext:
    fsGroup: 568
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 568
    runAsNonRoot: true
    runAsUser: 568

controllers:
  paperless:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    initContainers:
      tesseract-langs:
        image:
          repository: ghcr.io/paperless-ngx/paperless-ngx
          tag: "2.20.0"
        env:
          PAPERLESS_OCR_LANGUAGES: eng por pol
        command:
          - "/bin/bash"
          - "-c"
        args:
          - |
            set -e

            echo "Installing tesseract language packages..."

            # Update package lists
            apt-get update

            # Install languages from PAPERLESS_OCR_LANGUAGES
            # Convert space-separated list to apt package names (tesseract-ocr-<lang>)
            PACKAGES="tesseract-ocr"
            for lang in $PAPERLESS_OCR_LANGUAGES; do
              PACKAGES="$PACKAGES tesseract-ocr-$lang"
              echo "  - Adding tesseract-ocr-$lang"
            done

            # Install all packages (this includes osd.traineddata automatically)
            apt-get install -y --no-install-recommends $PACKAGES

            # Copy installed tessdata to shared volume
            TESSDIR=/shared-tessdata
            mkdir -p "$TESSDIR"
            cp -r /usr/share/tesseract-ocr/5/tessdata/* "$TESSDIR/"

            # Set proper permissions for the app user (568:568)
            chown -R 568:568 "$TESSDIR"

            # List installed languages for debugging
            echo "Installed tesseract data files:"
            ls -lh "$TESSDIR"

            # Clean up apt cache to reduce image size impact
            apt-get clean
            rm -rf /var/lib/apt/lists/*

            echo "Tesseract language packages installed successfully"
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
    containers:
      app:
        image:
          repository: ghcr.io/paperless-ngx/paperless-ngx
          tag: "2.20.0"
        env:
          TZ: Europe/Warsaw
          XDG_CACHE_HOME: /tmp/.cache
          PAPERLESS_URL: https://paperless.edgard.org
          PAPERLESS_PORT: "8000"
          PAPERLESS_TIME_ZONE: Europe/Warsaw
          PAPERLESS_WEBSERVER_WORKERS: "2"
          PAPERLESS_TASK_WORKERS: "2"
          PAPERLESS_BIND_ADDR: 0.0.0.0
          PAPERLESS_OCR_LANGUAGE: eng
          PAPERLESS_ALLOWED_HOSTS: paperless.edgard.org,paperless.edge-services.svc.cluster.local,paperless,localhost,127.0.0.1
          PAPERLESS_CSRF_TRUSTED_ORIGINS: https://paperless.edgard.org
          PAPERLESS_PROXY_SSL_HEADER: '["HTTP_X_FORWARDED_PROTO", "https"]'
          PAPERLESS_REDIS: redis://paperless-redis:6379
          PAPERLESS_TIKA_ENABLED: "1"
          PAPERLESS_TIKA_ENDPOINT: http://paperless-tika:9998
          PAPERLESS_TIKA_GOTENBERG_ENDPOINT: http://paperless-gotenberg:3000
          PAPERLESS_CONSUMER_POLLING: "60"
          PAPERLESS_CONSUMER_RECURSIVE: "true"
          PAPERLESS_CONSUMER_SUBDIRS_AS_TAGS: "true"
          PAPERLESS_CONSUMPTION_DIR: /usr/src/paperless/inbox
          PAPERLESS_SECRET_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-secret
                key: PAPERLESS_SECRET_KEY
          PAPERLESS_ADMIN_USER:
            valueFrom:
              secretKeyRef:
                name: paperless-secret
                key: PAPERLESS_ADMIN_USER
          PAPERLESS_ADMIN_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: paperless-secret
                key: PAPERLESS_ADMIN_PASSWORD
        probes:
          liveness:
            enabled: true
          readiness:
            enabled: true
          startup:
            enabled: true
            spec:
              failureThreshold: 30
              periodSeconds: 5

  gotenberg:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: docker.io/gotenberg/gotenberg
          tag: "8.25"
        args:
          - gotenberg
          - --chromium-disable-javascript=true
          - --chromium-allow-list=file:///tmp/.*

  tika:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: docker.io/apache/tika
          tag: "3.2.3.0"

  redis:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: docker.io/library/redis
          tag: "8"
        args:
          - redis-server
          - --save
          - "60"
          - "1"
          - --loglevel
          - warning

  paperless-ai:
    type: deployment
    replicas: 1
    strategy: Recreate
    annotations:
      reloader.stakater.com/auto: "true"
    initContainers:
      init-config:
        image:
          repository: busybox
          tag: latest
        command:
          - /bin/sh
          - -c
        args:
          - |
            mkdir -p /app/data
            cat > /app/data/.env << EOF
            PAPERLESS_API_URL=${PAPERLESS_API_URL}
            PAPERLESS_API_TOKEN=${PAPERLESS_API_TOKEN}
            PAPERLESS_USERNAME=${PAPERLESS_USERNAME}
            AI_PROVIDER=${AI_PROVIDER}
            CUSTOM_BASE_URL=${CUSTOM_BASE_URL}
            CUSTOM_API_KEY=${CUSTOM_API_KEY}
            CUSTOM_MODEL=${CUSTOM_MODEL}
            SCAN_INTERVAL=${SCAN_INTERVAL}
            SYSTEM_PROMPT=${SYSTEM_PROMPT}
            TOKEN_LIMIT=${TOKEN_LIMIT}
            RESPONSE_TOKENS=${RESPONSE_TOKENS}
            DISABLE_AUTOMATIC_PROCESSING=${DISABLE_AUTOMATIC_PROCESSING}
            ACTIVATE_TAGGING=${ACTIVATE_TAGGING}
            ACTIVATE_CORRESPONDENTS=${ACTIVATE_CORRESPONDENTS}
            ACTIVATE_DOCUMENT_TYPE=${ACTIVATE_DOCUMENT_TYPE}
            ACTIVATE_TITLE=${ACTIVATE_TITLE}
            ACTIVATE_CUSTOM_FIELDS=${ACTIVATE_CUSTOM_FIELDS}
            CUSTOM_FIELDS={"custom_fields":[]}
            RESTRICT_TO_EXISTING_TAGS=${RESTRICT_TO_EXISTING_TAGS}
            RESTRICT_TO_EXISTING_CORRESPONDENTS=${RESTRICT_TO_EXISTING_CORRESPONDENTS}
            RESTRICT_TO_EXISTING_DOCUMENT_TYPES=${RESTRICT_TO_EXISTING_DOCUMENT_TYPES}
            USE_EXISTING_DATA=${USE_EXISTING_DATA}
            PROCESS_PREDEFINED_DOCUMENTS=${PROCESS_PREDEFINED_DOCUMENTS}
            ADD_AI_PROCESSED_TAG=${ADD_AI_PROCESSED_TAG}
            RAG_SERVICE_URL=${RAG_SERVICE_URL}
            RAG_SERVICE_ENABLED=${RAG_SERVICE_ENABLED}
            PAPERLESS_AI_INITIAL_SETUP=yes
            EOF
            echo "Created .env file:"
            cat /app/data/.env
        env:
          PAPERLESS_API_URL: http://paperless.edge-services.svc.cluster.local:8000/api
          PAPERLESS_API_TOKEN:
            valueFrom:
              secretKeyRef:
                name: paperless-ai-secret
                key: PAPERLESS_API_TOKEN
          PAPERLESS_USERNAME:
            valueFrom:
              secretKeyRef:
                name: paperless-secret
                key: PAPERLESS_ADMIN_USER
          AI_PROVIDER: custom
          CUSTOM_BASE_URL: https://openrouter.ai/api/v1
          CUSTOM_API_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-ai-secret
                key: OPENAI_API_KEY
          CUSTOM_MODEL: anthropic/claude-sonnet-4.5
          SCAN_INTERVAL: "0 4 * * *"
          SYSTEM_PROMPT: "You are a document analysis AI for a multilingual user (English, Portuguese-BR, Polish). AVAILABLE TAGS (use ONLY these English tags): bank-statement, contract, employment, government, housing, insurance, invoice, legal, medical, payslip, receipt, shopping, subscription, tax, travel, user-manual, utilities. RULES: 1) Select tags ONLY from the list above - do NOT translate or create new tags. 2) For correspondents, use official/international company name. 3) Document_type must be in English (Invoice, Contract, Receipt, Letter, Bank Statement, etc). 4) Title: concise, in the ORIGINAL document language. 5) Dates: convert to YYYY-MM-DD format."
          TOKEN_LIMIT: "128000"
          RESPONSE_TOKENS: "1000"
          DISABLE_AUTOMATIC_PROCESSING: "no"
          ACTIVATE_TAGGING: "yes"
          ACTIVATE_CORRESPONDENTS: "yes"
          ACTIVATE_DOCUMENT_TYPE: "yes"
          ACTIVATE_TITLE: "yes"
          ACTIVATE_CUSTOM_FIELDS: "no"
          RESTRICT_TO_EXISTING_TAGS: "yes"
          RESTRICT_TO_EXISTING_CORRESPONDENTS: "no"
          RESTRICT_TO_EXISTING_DOCUMENT_TYPES: "no"
          USE_EXISTING_DATA: "no"
          PROCESS_PREDEFINED_DOCUMENTS: "no"
          ADD_AI_PROCESSED_TAG: "no"
          RAG_SERVICE_URL: http://localhost:8000
          RAG_SERVICE_ENABLED: "true"
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
    containers:
      app:
        image:
          repository: docker.io/clusterzx/paperless-ai
          tag: "3.0.9"
        securityContext:
          runAsUser: 0
          runAsGroup: 0
          runAsNonRoot: false
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
        env:
          TZ: Europe/Warsaw
          PUID: "568"
          PGID: "568"
          # === CORE SETUP ===
          # Enables configuration via environment variables (skips web wizard)
          PAPERLESS_AI_INITIAL_SETUP: "yes"
          # === PAPERLESS-NGX CONNECTION ===
          PAPERLESS_API_URL: http://paperless.edge-services.svc.cluster.local:8000/api
          PAPERLESS_API_TOKEN:
            valueFrom:
              secretKeyRef:
                name: paperless-ai-secret
                key: PAPERLESS_API_TOKEN
          PAPERLESS_USERNAME:
            valueFrom:
              secretKeyRef:
                name: paperless-secret
                key: PAPERLESS_ADMIN_USER
          # === AI PROVIDER (OpenRouter) ===
          AI_PROVIDER: custom
          CUSTOM_BASE_URL: https://openrouter.ai/api/v1
          CUSTOM_API_KEY:
            valueFrom:
              secretKeyRef:
                name: paperless-ai-secret
                key: OPENAI_API_KEY
          CUSTOM_MODEL: anthropic/claude-sonnet-4.5
          TOKEN_LIMIT: "128000"
          RESPONSE_TOKENS: "1000"
          # === AUTOMATIC PROCESSING ===
          DISABLE_AUTOMATIC_PROCESSING: "no"
          SCAN_INTERVAL: "0 4 * * *"
          ADD_AI_PROCESSED_TAG: "no"
          # === FEATURE TOGGLES ===
          ACTIVATE_TAGGING: "yes"
          ACTIVATE_CORRESPONDENTS: "yes"
          ACTIVATE_DOCUMENT_TYPE: "yes"
          ACTIVATE_TITLE: "yes"
          ACTIVATE_CUSTOM_FIELDS: "no"
          # === RESTRICTIONS (use existing metadata only) ===
          RESTRICT_TO_EXISTING_TAGS: "yes"
          RESTRICT_TO_EXISTING_CORRESPONDENTS: "no"
          RESTRICT_TO_EXISTING_DOCUMENT_TYPES: "no"
          # === OPTIONAL SETTINGS ===
          USE_EXISTING_DATA: "no"
          PROCESS_PREDEFINED_DOCUMENTS: "no"
          # === SYSTEM PROMPT (multilingual support) ===
          SYSTEM_PROMPT: "You are a document analysis AI for a multilingual user (English, Portuguese-BR, Polish). AVAILABLE TAGS (use ONLY these English tags): bank-statement, contract, employment, government, housing, insurance, invoice, legal, medical, payslip, receipt, shopping, subscription, tax, travel, user-manual, utilities. RULES: 1) Select tags ONLY from the list above - do NOT translate or create new tags. 2) For correspondents, use official/international company name. 3) Document_type must be in English (Invoice, Contract, Receipt, Letter, Bank Statement, etc). 4) Title: concise, in the ORIGINAL document language. 5) Dates: convert to YYYY-MM-DD format."
          # === RAG SERVICE (semantic search/chat) ===
          RAG_SERVICE_URL: http://localhost:8000
          RAG_SERVICE_ENABLED: "true"

service:
  paperless:
    controller: paperless
    primary: true
    labels:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 8000

  ai:
    controller: paperless-ai
    labels:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 3000

  gotenberg:
    controller: gotenberg
    ports:
      http:
        port: 3000

  tika:
    controller: tika
    ports:
      http:
        port: 9998

  redis:
    controller: redis
    ports:
      redis:
        port: 6379

ingress:
  main:
    enabled: false

persistence:
  data:
    type: hostPath
    hostPath: /mnt/spool/appdata/paperless
    hostPathType: DirectoryOrCreate
    advancedMounts:
      paperless:
        app:
          - path: /usr/src/paperless/data
            subPath: data
          - path: /usr/src/paperless/media
            subPath: media
          - path: /usr/src/paperless/export
            subPath: export
          - path: /usr/src/paperless/inbox
            subPath: inbox
      redis:
        app:
          - path: /data
            subPath: redis

  ai:
    type: hostPath
    hostPath: /mnt/spool/appdata/paperless-ai
    hostPathType: DirectoryOrCreate
    advancedMounts:
      paperless-ai:
        init-config:
          - path: /app/data
            subPath: data
        app:
          - path: /app/data
            subPath: data

  tessdata:
    type: emptyDir
    advancedMounts:
      paperless:
        tesseract-langs:
          - path: /shared-tessdata
        app:
          - path: /usr/share/tesseract-ocr/5/tessdata

  cache:
    type: emptyDir
    advancedMounts:
      paperless:
        app:
          - path: /tmp/.cache
