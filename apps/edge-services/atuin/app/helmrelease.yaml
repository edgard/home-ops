---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: atuin
  namespace: edge-services
spec:
  releaseName: atuin
  interval: 30m
  driftDetection:
    mode: enabled
  chartRef:
    kind: OCIRepository
    name: atuin
  values:
    controllers:
      main:
        type: deployment
        replicas: 1
        strategy: Recreate
        pod:
          securityContext:
            fsGroup: 1000
            runAsGroup: 1000
            runAsNonRoot: true
            runAsUser: 1000
        containers:
          main:
            image:
              repository: ghcr.io/atuinsh/atuin
              tag: v18.10.0
            command:
              - atuin
            args:
              - server
              - start
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
            env:
              ATUIN_DB_URI: sqlite:///config/atuin.db
              ATUIN_HOST: 0.0.0.0
              ATUIN_PORT: "8888"
              ATUIN_OPEN_REGISTRATION: "false"
            ports:
              - name: http
                containerPort: 8888
            probes:
              liveness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: http
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
              readiness:
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /
                    port: http
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 3
    service:
      main:
        controller: main
        type: ClusterIP
        labels:
          gatus.edgard.org/enabled: "true"
        ports:
          http:
            enabled: true
            port: 8888
            targetPort: http
    ingress:
      main:
        enabled: false
    persistence:
      config:
        type: hostPath
        hostPathType: DirectoryOrCreate
        hostPath: /mnt/spool/appdata/atuin
        globalMounts:
          - path: /config
