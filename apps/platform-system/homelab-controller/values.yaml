---
defaultPodOptions:
  securityContext:
    fsGroup: 1000
    fsGroupChangePolicy: OnRootMismatch
    runAsGroup: 1000
    runAsNonRoot: true
    runAsUser: 1000

controllers:
  main:
    annotations:
      reloader.stakater.com/auto: "true"
    type: deployment
    replicas: 1
    strategy: Recreate
    serviceAccount:
      identifier: main
    containers:
      app:
        image:
          repository: python
          tag: 3.14.3-slim
        command:
          - /bin/sh
          - -c
          - |
            set -euo pipefail
            if ! pip install --user --no-cache-dir kopf kubernetes pyyaml; then
              echo "ERROR: Failed to install required packages" >&2
              exit 1
            fi
            export PATH="/tmp/.local/bin:$PATH"
            kopf run --verbose /scripts/controller.py
        env:
          HOME: /tmp
          USER: homelab-controller
          PYTHONUNBUFFERED: "1"
          KOPF_LOG_LEVEL: INFO
          HTTP_PORT: "8080"
        resources:
          limits: null
          requests: null
        probes:
          startup:
            enabled: true
            port: 8080
          liveness:
            enabled: true
            port: 8080
          readiness:
            enabled: true
            port: 8080
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL

serviceAccount:
  main:
    enabled: true

rbac:
  roles:
    main:
      type: ClusterRole
      rules:
        - apiGroups:
            - homelab.edgard.org
          resources:
            - gatusconfigs
          verbs:
            - get
            - list
            - watch
            - patch
        - apiGroups:
            - homelab.edgard.org
          resources:
            - gatusconfigs/status
          verbs:
            - update
            - patch
        - apiGroups:
            - ""
          resources:
            - configmaps
          verbs:
            - get
            - list
            - watch
            - create
            - update
            - patch
        - apiGroups:
            - ""
          resources:
            - services
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - apps
          resources:
            - deployments
            - statefulsets
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - ""
          resources:
            - events
          verbs:
            - create
            - patch
        - apiGroups:
            - apiextensions.k8s.io
          resources:
            - customresourcedefinitions
          verbs:
            - get
            - list
            - watch
        - apiGroups:
            - coordination.k8s.io
          resources:
            - leases
          verbs:
            - get
            - list
            - watch
            - create
            - update
            - patch
  bindings:
    main:
      type: ClusterRoleBinding
      roleRef:
        identifier: main
      subjects:
        - identifier: main
          kind: ServiceAccount

service:
  main:
    controller: main
    annotations:
      gatus.edgard.org/enabled: "true"
    ports:
      http:
        port: 80
        targetPort: 8080

persistence:
  controller:
    type: configMap
    name: homelab-controller-controller
    defaultMode: 0444
    globalMounts:
      - path: /scripts/controller.py
        subPath: controller.py
        readOnly: true
  http-server:
    type: configMap
    name: homelab-controller-http-server
    defaultMode: 0444
    globalMounts:
      - path: /scripts/http_server.py
        subPath: http_server.py
        readOnly: true
  gatus-generator:
    type: configMap
    name: homelab-controller-gatus-generator
    defaultMode: 0444
    globalMounts:
      - path: /scripts/gatus_generator.py
        subPath: gatus_generator.py
        readOnly: true
