---
defaultPodOptions:
  securityContext:
    runAsGroup: 0
    runAsUser: 0

controllers:
  main:
    type: deployment
    replicas: 1
    strategy: Recreate
    containers:
      app:
        image:
          repository: creativeprojects/resticprofile
          tag: 0.32.0
          pullPolicy: IfNotPresent
        securityContext:
          allowPrivilegeEscalation: false
        command:
          - "/bin/sh"
        args:
          - "-c"
          - "resticprofile schedule --all --no-ansi && crond -f"

persistence:
  config:
    type: configMap
    identifier: config
    globalMounts:
      - path: /etc/resticprofile/profiles.yaml
        subPath: profiles.yaml
        readOnly: true
  secrets:
    type: secret
    name: restic-credentials
    globalMounts:
      - path: /secrets
  data:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    size: 5Gi
    globalMounts:
      - path: /root/.cache
  backup:
    type: persistentVolumeClaim
    accessMode: ReadWriteOnce
    storageClass: local-bulk
    size: 5Ti
    globalMounts:
      - path: /backup
  appdata:
    type: hostPath
    hostPath: /mnt/spool/appdata
    hostPathType: Directory
    advancedMounts:
      main:
        app:
          - path: /mnt/spool/appdata

configMaps:
  config:
    data:
      profiles.yaml: |-
        version: "1"
        global:
          restic-binary: /usr/bin/restic
          scheduler: crond
          priority: low

        default:
          repository: "local:/backup"
          password-file: "/secrets/RESTIC_PASSWORD"
          initialize: true
          host: "homelab"
          run-after:
            - "chown -R 1000:1000 /backup"

        appdata:
          inherit: "default"
          backup:
            source: "/mnt/spool/appdata"
            schedule: "03:00"
            schedule-permission: system
          check:
            read-data: true
            schedule: "Sun 01:00"
            schedule-permission: system
          retention:
            after-backup: true
            keep-daily: 7
            keep-weekly: 4
            keep-monthly: 12
            keep-yearly: 3
            prune: true
