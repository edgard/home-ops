---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: envoy-gateway-global-coraza
  namespace: platform-system
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-gateway-external
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: envoy-gateway-internal
  wasm:
    - name: coraza-waf
      code:
        type: Image
        image:
          url: ghcr.io/corazawaf/coraza-proxy-wasm:0.6.0
      config:
        directives_map:
          default:
            - Include @recommended-conf
            - SecRuleEngine On
            - SecAuditEngine RelevantOnly
            - SecDebugLogLevel 1
            - Include @crs-setup-conf
            - Include @owasp_crs/*.conf
        default_directives: default
        metric_labels:
          gateway: envoy-gateway-global
          env: homelab
      # Coraza WASM occasionally fails to load on bootstrap due to cache mTLS timing.
      # Allow traffic to continue if the module cannot be fetched/initialized so auth/login flows arenâ€™t blocked.
      failOpen: true
