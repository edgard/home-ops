---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kopia-init
  namespace: platform-system
data:
  init.sh: |-
    #!/bin/sh
    set -e

    REPO_PATH="/repository"
    CONFIG_DIR="/app/config"

    echo "==> Checking if Kopia repository exists at $REPO_PATH..."

    if [ -f "$REPO_PATH/kopia.repository.f" ]; then
      echo "==> Repository already exists, connecting..."
      kopia repository connect filesystem \
        --path="$REPO_PATH" \
        --config-file="$CONFIG_DIR/repository.config" \
        --override-hostname=homelab \
        --override-username=admin

      echo "==> Repository connection successful!"
    else
      echo "==> Repository does not exist, creating..."

      kopia repository create filesystem \
        --path="$REPO_PATH" \
        --config-file="$CONFIG_DIR/repository.config" \
        --override-hostname=homelab \
        --override-username=admin \
        --description="Homelab backup repository"

      echo "==> Repository created successfully!"
    fi

    echo "==> Setting global retention policy..."
    kopia policy set --global \
      --config-file="$CONFIG_DIR/repository.config" \
      --keep-latest=6 \
      --keep-hourly=24 \
      --keep-daily=7 \
      --keep-weekly=4 \
      --keep-monthly=12 \
      --keep-annual=3

    echo "==> Configuring policy for /data/appdata..."
    kopia policy set /data/appdata \
      --config-file="$CONFIG_DIR/repository.config" \
      --snapshot-time=03:00 \
      --run-missed=true

    echo "==> Ensuring users exist..."

    if [ -z "$KOPIA_USERS" ]; then
      echo "No users specified in KOPIA_USERS environment variable."
    else
      for user in $KOPIA_USERS; do
        echo "Processing user: $user"
        # Try to add the user. If it fails (likely exists), update the password.
        if ! kopia server user add "$user" \
          --config-file="$CONFIG_DIR/repository.config" \
          --user-password="$KOPIA_SERVER_CONTROL_PASSWORD" 2>/dev/null; then

          echo "User $user already exists, updating password..."
          kopia server user set "$user" \
            --config-file="$CONFIG_DIR/repository.config" \
            --user-password="$KOPIA_SERVER_CONTROL_PASSWORD"
        fi
      done
    fi

    echo "==> Initialization complete!"
