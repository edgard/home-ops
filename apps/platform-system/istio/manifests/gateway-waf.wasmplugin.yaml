apiVersion: extensions.istio.io/v1alpha1
kind: WasmPlugin
metadata:
  name: gateway-waf
  namespace: platform-system
spec:
  url: oci://ghcr.io/corazawaf/coraza-proxy-wasm:0.6.0
  imagePullPolicy: IfNotPresent
  phase: AUTHZ
  priority: 10
  pluginConfig:
    default_directives: default
    directives_map:
      default:
        - Include @recommended-conf
        - SecRuleEngine On
        - SecDebugLogLevel 3
        - SecAction "id:100000,phase:1,pass,t:none,nolog,setvar:tx.blocking_paranoia_level=1"
        - SecAction "id:100001,phase:1,pass,t:none,nolog,setvar:tx.inbound_anomaly_score_threshold=25"
        - SecAction "id:100002,phase:1,pass,t:none,nolog,setvar:tx.outbound_anomaly_score_threshold=10"
        - Include @crs-setup-conf
        - Include @owasp_crs/*.conf
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: gateway-external
    - group: gateway.networking.k8s.io
      kind: Gateway
      name: gateway-internal
