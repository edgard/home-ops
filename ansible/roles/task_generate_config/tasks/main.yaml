---
- name: Generate Ansible all group vars secrets
  community.sops.sops_encrypt:
    path: "{{ playbook_dir }}/group_vars/all.sops.yaml"
    content_yaml: "{{ lookup('template', 'ansible_group_all.yaml.j2') | from_yaml }}"

- name: Generate Terraform secrets
  community.sops.sops_encrypt:
    path: "{{ playbook_dir }}/../terraform/secrets.sops.yaml"
    content_yaml: "{{ lookup('template', 'terraform_secrets.yaml.j2') | from_yaml }}"

- name: Generate Cluster secrets
  community.sops.sops_encrypt:
    path: "{{ playbook_dir }}/../cluster/manifests/config/cluster-secrets.sops.yaml"
    content_yaml: "{{ lookup('template', 'cluster_secrets.yaml.j2') | from_yaml }}"
    encrypted_regex: "^(data|stringData)$"

- name: Generate Cloudflared secrets
  community.sops.sops_encrypt:
    path: "{{ playbook_dir }}/../cluster/manifests/apps/infra-system/cloudflared/secrets.sops.yaml"
    content_yaml: "{{ lookup('template', 'cloudflared_secrets.yaml.j2') | from_yaml }}"
    encrypted_regex: "^(data|stringData)$"

- name: Template envrc
  ansible.builtin.template:
    src: "envrc.j2"
    dest: "{{ playbook_dir }}/../.envrc"
    mode: "0644"
