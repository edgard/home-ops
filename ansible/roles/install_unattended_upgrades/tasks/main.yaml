---
- name: Install unattended-upgrades
  ansible.builtin.apt:
    name:
      - unattended-upgrades
    state: present

- name: Config unattended-upgrades
  ansible.builtin.lineinfile:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    regexp: "{{ item.key }}"
    line: "{{ item.value }}"
    backrefs: true
  with_dict: "{{ unattended_config }}"
  vars:
    unattended_config:
      "^(//)?(Unattended-Upgrade::AutoFixInterruptedDpkg\\s)": '\2"true";'
      "^(//)?(Unattended-Upgrade::MinimalSteps\\s)": '\2"true";'
      "^(//)?(Unattended-Upgrade::InstallOnShutdown\\s)": '\2"false";'
      "^(//)?(Unattended-Upgrade::Automatic-Reboot\\s)": '\2"false";'
  notify: "Restart unattended-upgrades"
