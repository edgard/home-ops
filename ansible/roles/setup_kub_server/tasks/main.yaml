---
- name: Install packages
  ansible.builtin.apt:
    name:
      - build-essential
    state: present

- name: Ensure required kernel modules are loaded
  ansible.builtin.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - br_netfilter
    - overlay
    - iptable_nat
    - iptable_filter

- name: Set sysctl parameters for k8s/containerd
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    sysctl_set: yes
    reload: yes
  loop:
    - { name: 'net.ipv4.ip_forward', value: 1 }
    - { name: 'net.bridge.bridge-nf-call-iptables', value: 1 }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: 1 }
    - { name: 'vm.overcommit_memory', value: 1 }
    - { name: 'fs.inotify.max_user_instances', value: 8192 }
    - { name: 'fs.inotify.max_user_watches', value: 524288 }
    - { name: 'net.netfilter.nf_conntrack_max', value: 196608 }
    - { name: 'net.core.rmem_max', value: 2500000 }
    - { name: 'net.core.wmem_max', value: 2500000 }
