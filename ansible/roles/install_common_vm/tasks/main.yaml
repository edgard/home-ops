---
- name: Install packages
  ansible.builtin.apt:
    name:
      - qemu-guest-agent
      - nfs-common
    state: present

- name: Install HWE kernel
  ansible.builtin.apt:
    name: linux-generic-hwe-{{ ansible_distribution_version }}
    install_recommends: true
    state: present

- name: Clean up dependencies that are no longer required
  ansible.builtin.apt:
    autoremove: true
    purge: true

- name: Set kernel options in Grub
  ansible.builtin.replace:
    path: /etc/default/grub
    regexp: '^(GRUB_CMDLINE_LINUX=(?:(?![" ]{{ item.key | regex_escape }}=).)*)(?:[" ]{{ item.key | regex_escape }}=\S+)?(.*")$'
    replace: '\1 {{ item.key }}={{ item.value }}\2'
  with_dict: "{{ grub_config }}"
  vars:
    grub_config:
      apparmor: 0
      mitigations: "off"
      pti: "off"
  notify: Run grub-mkconfig
