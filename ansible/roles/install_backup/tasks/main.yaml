---
- name: Install packages
  apt:
    name:
      - nfs-common
      - restic
    state: present

- name: Create backup directory
  file:
    path: "{{ restic_repo_dir }}"
    state: directory

- name: Mount backup volume
  mount:
    src: "{{ restic_repo_mount }}"
    path: "{{ restic_repo_dir }}"
    state: mounted
    fstype: nfs

- name: Configure backup
  cron:
    name: Backup daily
    minute: "0"
    hour: "6"
    user: root
    job: 'RESTIC_REPOSITORY="{{ restic_repo_dir }}" RESTIC_PASSWORD="{{ restic_repo_pass }}" restic backup --host {{ ansible_hostname }} "{{ backup_path }}"'
